<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>URL Encoder Decoder & QR Generator | UtilHub</title>
<meta name="description" content="Encode and decode URLs, parse URL parameters, and generate QR codes from any link. Free online URL toolkit.">
<meta name="robots" content="index, follow">
<link rel="canonical" href="https://utilhub.app/url-tools">
<meta property="og:type" content="website">
<meta property="og:title" content="URL Encoder Decoder & QR Generator | UtilHub">
<meta property="og:description" content="Encode and decode URLs, parse URL parameters, and generate QR codes from any link. Free online URL toolkit.">
<meta property="og:url" content="https://utilhub.app/url-tools">
<meta property="og:site_name" content="UtilHub">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="URL Encoder Decoder & QR Generator">
<meta name="twitter:description" content="Encode and decode URLs, parse URL parameters, and generate QR codes from any link. Free online URL toolkit.">
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üß∞</text></svg>">
<!-- Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Z64R0T7TZ6"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-Z64R0T7TZ6');</script>
<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6253800197711103" crossorigin="anonymous"></script>
<meta name="google-adsense-account" content="ca-pub-6253800197711103">
<!-- Schema.org -->
<script type="application/ld+json">{"@context":"https://schema.org","@type":"WebApplication","name":"URL Tools","url":"https://utilhub.app/url-tools","description":"Encode and decode URLs, parse URL parameters, and generate QR codes from any link. Free online URL toolkit.","applicationCategory":"UtilitiesApplication","operatingSystem":"Web Browser","offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}}</script>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"FAQPage","mainEntity":[{"@type":"Question","name":"What does URL encoding do?","acceptedAnswer":{"@type":"Answer","text":"It converts special characters (spaces, &, =, etc.) into percent-encoded format (%20, %26, %3D) for safe use in URLs."}},{"@type":"Question","name":"Can I see all URL parameters?","acceptedAnswer":{"@type":"Answer","text":"Yes, the URL Parser shows each query parameter as a separate key-value pair in a clear table."}},{"@type":"Question","name":"Can I generate a QR code from any URL?","acceptedAnswer":{"@type":"Answer","text":"Yes! Enter any URL and click Generate to create a downloadable QR code."}}]}</script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,500;0,9..40,700;1,9..40,400&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/9.1.6/marked.min.js"></script>
<style>

:root{--bg:#0a0a0c;--surface:#131318;--surface2:#1a1a22;--surface3:#22222e;--border:#2a2a38;--text:#e8e6f0;--text2:#9896a8;--accent:#6c5ce7;--accent2:#a29bfe;--accent-glow:rgba(108,92,231,.3);--green:#00b894;--orange:#fdcb6e;--red:#e17055;--pink:#fd79a8;--radius:16px;--radius-sm:10px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
header{position:sticky;top:0;z-index:100;background:rgba(10,10,12,.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);padding:0 24px}
.header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;height:64px}
.logo{font-family:'Instrument Serif',serif;font-size:28px;color:var(--text);text-decoration:none;display:flex;align-items:center;gap:8px}
.logo span{background:linear-gradient(135deg,var(--accent),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header-search{display:flex;align-items:center;background:var(--surface);border:1px solid var(--border);border-radius:40px;padding:8px 16px;gap:8px;width:320px;transition:border-color .3s}
.header-search:focus-within{border-color:var(--accent)}
.header-search svg{color:var(--text2);flex-shrink:0}
.header-search input{background:none;border:none;outline:none;color:var(--text);font-size:14px;width:100%;font-family:inherit}
.header-search input::placeholder{color:var(--text2)}
.hero{text-align:center;padding:80px 24px 60px;position:relative;overflow:hidden}
.hero::before{content:'';position:absolute;top:-200px;left:50%;transform:translateX(-50%);width:800px;height:600px;background:radial-gradient(ellipse,var(--accent-glow) 0%,transparent 70%);pointer-events:none}
.hero h1{font-family:'Instrument Serif',serif;font-size:clamp(36px,6vw,64px);line-height:1.1;margin-bottom:16px;position:relative}
.hero h1 em{font-style:italic;background:linear-gradient(135deg,var(--accent2),var(--pink));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero p{color:var(--text2);font-size:18px;max-width:520px;margin:0 auto;position:relative}
.categories{display:flex;justify-content:center;gap:8px;padding:0 24px 40px;flex-wrap:wrap}
.cat-btn{padding:10px 20px;border-radius:40px;border:1px solid var(--border);background:var(--surface);color:var(--text2);font-size:14px;font-family:inherit;cursor:pointer;transition:all .3s;display:flex;align-items:center;gap:6px}
.cat-btn:hover,.cat-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);box-shadow:0 4px 20px var(--accent-glow)}
.tools-section{max-width:1200px;margin:0 auto;padding:0 24px 60px}
.tools-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
.tool-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:28px 24px;cursor:pointer;transition:all .35s cubic-bezier(.4,0,.2,1);position:relative;overflow:hidden}
.tool-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--pink));opacity:0;transition:opacity .3s}
.tool-card:hover{border-color:var(--accent);transform:translateY(-4px);box-shadow:0 12px 40px rgba(0,0,0,.4)}
.tool-card:hover::before{opacity:1}
.tool-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;margin-bottom:16px}
.tool-card h3{font-size:16px;font-weight:700;margin-bottom:6px}
.tool-card p{font-size:13px;color:var(--text2);line-height:1.5}
.tool-tag{display:inline-block;margin-top:12px;font-size:11px;padding:4px 10px;border-radius:20px;background:var(--surface3);color:var(--text2)}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;align-items:center;justify-content:center;padding:20px}
.modal-overlay.active{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:100%;max-width:700px;max-height:90vh;overflow-y:auto;padding:40px;position:relative;animation:modalIn .35s cubic-bezier(.4,0,.2,1)}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-close{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;border:1px solid var(--border);background:var(--surface2);color:var(--text2);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.modal-close:hover{background:var(--red);color:#fff;border-color:var(--red)}
.modal h2{font-family:'Instrument Serif',serif;font-size:28px;margin-bottom:8px}
.modal .subtitle{color:var(--text2);font-size:14px;margin-bottom:28px}
.drop-zone{border:2px dashed var(--border);border-radius:var(--radius-sm);padding:40px 20px;text-align:center;cursor:pointer;transition:all .3s;margin-bottom:20px;background:var(--surface2)}
.drop-zone:hover{border-color:var(--accent);background:rgba(108,92,231,.05)}
.drop-zone svg{margin-bottom:8px;color:var(--text2)}
.drop-zone p{color:var(--text2);font-size:14px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:13px;font-weight:500;margin-bottom:8px;color:var(--text2)}
.form-input,.form-select,.form-textarea{width:100%;padding:12px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text);font-size:14px;font-family:inherit;outline:none;transition:border-color .3s}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--accent)}
.form-textarea{resize:vertical;min-height:120px}
.form-select{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239896a8' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px}
.btn{padding:12px 28px;border-radius:var(--radius-sm);border:none;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,var(--accent),#8b5cf6);color:#fff;box-shadow:0 4px 15px var(--accent-glow)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 25px var(--accent-glow)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}
.btn-secondary{background:var(--surface3);color:var(--text);border:1px solid var(--border)}
.result-area{margin-top:20px;padding:20px;background:var(--surface2);border-radius:var(--radius-sm);border:1px solid var(--border);display:none}
.result-area.active{display:block}
.stats-row{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.stat-box{background:var(--surface3);padding:12px 16px;border-radius:var(--radius-sm);flex:1;min-width:120px}
.stat-box .label{font-size:11px;color:var(--text2);margin-bottom:4px}
.stat-box .value{font-size:18px;font-weight:700}
.stat-box .value.green{color:var(--green)}
.stat-box .value.orange{color:var(--orange)}
.slider-group{display:flex;align-items:center;gap:12px}
.slider-group input[type="range"]{flex:1;accent-color:var(--accent);height:6px}
.slider-val{background:var(--surface3);padding:4px 10px;border-radius:6px;font-size:13px;font-weight:600;min-width:48px;text-align:center}
.check-group{display:flex;flex-wrap:wrap;gap:12px;margin-bottom:16px}
.check-group label{display:flex;align-items:center;gap:6px;font-size:13px;color:var(--text2);cursor:pointer}
.check-group input[type="checkbox"]{accent-color:var(--accent)}
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--surface2);border-radius:var(--radius-sm);padding:4px}
.tab-btn{flex:1;padding:10px;border:none;background:transparent;color:var(--text2);font-family:inherit;font-size:13px;border-radius:8px;cursor:pointer;transition:all .2s}
.tab-btn.active{background:var(--accent);color:#fff}
.preview-box{background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:20px;max-height:300px;overflow-y:auto;font-size:14px;line-height:1.7}
.preview-box h1,.preview-box h2,.preview-box h3{margin:12px 0 8px}
.preview-box p{margin-bottom:8px}
.preview-box code{background:var(--surface3);padding:2px 6px;border-radius:4px;font-size:13px}
.preview-box pre{background:var(--surface3);padding:12px;border-radius:8px;overflow-x:auto}
.preview-box pre code{background:none;padding:0}
.copy-toast{position:fixed;bottom:30px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--green);color:#fff;padding:12px 24px;border-radius:40px;font-size:14px;font-weight:600;z-index:999;transition:transform .4s cubic-bezier(.4,0,.2,1);pointer-events:none}
.copy-toast.show{transform:translateX(-50%) translateY(0)}
@keyframes spin{to{transform:rotate(360deg)}}
.spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 12px}
.ad-banner{max-width:1200px;margin:0 auto 40px;padding:0 24px}
.ad-placeholder{background:var(--surface);border:1px dashed var(--border);border-radius:var(--radius-sm);height:100px;display:flex;align-items:center;justify-content:center;color:var(--text2);font-size:13px;gap:8px}
.audio-disclaimer{background:linear-gradient(135deg,rgba(108,92,231,.08),rgba(253,121,168,.08));border:1px solid rgba(108,92,231,.2);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px;font-size:13px;line-height:1.6;color:var(--text2)}
.audio-disclaimer strong{color:var(--accent2)}
.password-display{font-family:'Courier New',monospace;font-size:22px;letter-spacing:2px;word-break:break-all;padding:16px;background:var(--bg);border-radius:var(--radius-sm);text-align:center;margin-bottom:16px;border:1px solid var(--border);cursor:pointer;transition:border-color .2s}
.password-display:hover{border-color:var(--accent)}
.strength-bar{height:6px;border-radius:3px;background:var(--surface3);overflow:hidden;margin-bottom:8px}
.strength-fill{height:100%;border-radius:3px;transition:width .4s,background .4s}
footer{border-top:1px solid var(--border);padding:40px 24px;text-align:center}
footer p{color:var(--text2);font-size:13px}
footer a{color:var(--accent2);text-decoration:none}
@media(max-width:640px){.header-search{display:none}.modal{padding:24px}.hero{padding:50px 20px 40px}.tools-grid{grid-template-columns:1fr}}
::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px}

.tool-page{max-width:700px;margin:0 auto;padding:40px 24px 60px}
.tool-page h1{font-family:'Instrument Serif',serif;font-size:clamp(28px,5vw,42px);margin-bottom:8px}
.tool-page .subtitle{color:var(--text2);font-size:15px;margin-bottom:32px}
.breadcrumb{max-width:700px;margin:0 auto;padding:16px 24px 0;font-size:13px;color:var(--text2)}
.breadcrumb a{color:var(--accent2);text-decoration:none}
.breadcrumb a:hover{text-decoration:underline}
.section-title{font-family:'Instrument Serif',serif;font-size:24px;margin:48px 0 16px;padding-top:24px;border-top:1px solid var(--border)}
details summary::-webkit-details-marker{display:none}
details[open] summary span{transform:rotate(45deg)}
</style>
</head>
<body>
<div class="copy-toast" id="toast">Copied!</div>
<header><div class="header-inner">
  <a href="/" class="logo"><span>Util</span>Hub</a>
  <a href="/" style="color:var(--accent2);text-decoration:none;font-size:14px">‚Üê All Tools</a>
</div></header>

<nav class="breadcrumb">
  <a href="/">UtilHub</a> ‚Üí <a href="/">Developer Tools</a> ‚Üí URL Tools
</nav>

<div class="tool-page">
  <h1>üîó URL Tools</h1>
  <p class="subtitle">Free, no signup, runs entirely in your browser</p>

  <!-- AD SLOT -->
  <div style="margin-bottom:24px"><div class="ad-placeholder" id="ad-tool-top" style="height:90px">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>
    Ad Space
  </div></div>

  <!-- TOOL CONTENT (loaded from main app) -->
  <div id="toolContainer" style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:32px"></div>

  <!-- AD SLOT -->
  <div style="margin:32px 0"><div class="ad-placeholder" id="ad-tool-mid" style="height:90px">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>
    Ad Space
  </div></div>

  <!-- HOW IT WORKS -->
  <h2 class="section-title">How It Works</h2>
  <p style="color:var(--text2);font-size:15px;line-height:1.8;margin-bottom:24px">Three tools in one: URL Encode/Decode converts special characters for safe URL transmission. URL Parser breaks down any URL into protocol, host, path, and query parameters. URL to QR generates a scannable QR code from any link.</p>

  <!-- FAQ -->
  <h2 class="section-title">Frequently Asked Questions</h2>
  <div style="margin-bottom:32px">
    
        <details style="border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px">
          <summary style="padding:14px 18px;cursor:pointer;font-weight:600;font-size:15px;list-style:none;display:flex;justify-content:space-between;align-items:center">What does URL encoding do?<span style="color:var(--accent2);font-size:20px;transition:transform .2s">+</span></summary>
          <div style="padding:0 18px 14px;color:var(--text2);font-size:14px;line-height:1.7">It converts special characters (spaces, &, =, etc.) into percent-encoded format (%20, %26, %3D) for safe use in URLs.</div>
        </details>

        <details style="border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px">
          <summary style="padding:14px 18px;cursor:pointer;font-weight:600;font-size:15px;list-style:none;display:flex;justify-content:space-between;align-items:center">Can I see all URL parameters?<span style="color:var(--accent2);font-size:20px;transition:transform .2s">+</span></summary>
          <div style="padding:0 18px 14px;color:var(--text2);font-size:14px;line-height:1.7">Yes, the URL Parser shows each query parameter as a separate key-value pair in a clear table.</div>
        </details>

        <details style="border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px">
          <summary style="padding:14px 18px;cursor:pointer;font-weight:600;font-size:15px;list-style:none;display:flex;justify-content:space-between;align-items:center">Can I generate a QR code from any URL?<span style="color:var(--accent2);font-size:20px;transition:transform .2s">+</span></summary>
          <div style="padding:0 18px 14px;color:var(--text2);font-size:14px;line-height:1.7">Yes! Enter any URL and click Generate to create a downloadable QR code.</div>
        </details>
  </div>

  <!-- RELATED TOOLS -->
  <h2 class="section-title">Related Tools</h2>
  <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:32px">
    <a href="/qr-code-generator" style="display:inline-block;padding:8px 16px;background:var(--surface3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--accent2);text-decoration:none;font-size:13px;transition:all .2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">üì± QR Code Generator</a>
          <a href="/json-formatter" style="display:inline-block;padding:8px 16px;background:var(--surface3);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--accent2);text-decoration:none;font-size:13px;transition:all .2s" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">{ } JSON Formatter & Validator</a>
  </div>

  <!-- AD SLOT -->
  <div style="margin:32px 0"><div class="ad-placeholder" id="ad-tool-bottom" style="height:90px">
    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M9 9h6v6H9z"/></svg>
    Ad Space
  </div></div>

  <!-- BACK TO ALL TOOLS -->
  <div style="text-align:center;padding:20px 0">
    <a href="/" class="btn btn-primary" style="text-decoration:none">üß∞ View All 37+ Tools</a>
  </div>
</div>

<footer>
  <p>UtilHub &copy; 2025 ‚Äî Free online tools. All tools run locally in your browser.</p>
  <p style="margin-top:8px">
    <a href="/privacy">Privacy Policy</a> ¬∑ 
    <a href="/terms">Terms of Use</a> ¬∑ 
    <a href="/about">About</a>
  </p>
  <p style="margin-top:12px;font-size:11px;color:var(--text2)">Made with ‚ù§Ô∏è ‚Äî 37+ tools, zero signups, 100% free</p>
</footer>

<script>
// Load tool HTML and JS

var speedFileArrayBuffer = null;
var stemFileArrayBuffer = null;
var fxFileArrayBuffer = null;

const AUDIO_DISCLAIMER = `<div class="audio-disclaimer">
  <strong>üéµ 100% Free ‚Äî Runs in Your Browser</strong><br>
  This tool processes audio locally using signal processing algorithms (no AI). 
  Results may differ from paid AI-powered services like LALAL.ai or iZotope. 
  No files are uploaded to any server ‚Äî your audio stays private.
</div>`;

const tools = [
  { id:'compress-img', name:'Compress Image', desc:'Reduce JPG and PNG file sizes without visible quality loss.', icon:'üì¶', iconBg:'#6c5ce7', category:'image', tag:'Popular' },
  { id:'resize-img', name:'Resize Image', desc:'Change image width and height with or without aspect ratio lock.', icon:'‚ÜîÔ∏è', iconBg:'#0984e3', category:'image', tag:'Useful' },
  { id:'convert-img', name:'Convert Image', desc:'Convert between PNG, JPG, WEBP and BMP formats easily.', icon:'üîÑ', iconBg:'#00b894', category:'image', tag:'New' },
  { id:'qrcode', name:'QR Code Generator', desc:'Create custom QR Codes with custom colors and sizes.', icon:'üì±', iconBg:'#e17055', category:'dev', tag:'Popular' },
  { id:'color-picker', name:'Color Palette', desc:'Explore colors with HEX, RGB, HSL conversion and harmonic palettes.', icon:'üé®', iconBg:'#fd79a8', category:'dev', tag:'Useful' },
  { id:'password-gen', name:'Password Generator', desc:'Create secure, customizable passwords with strength indicator.', icon:'üîë', iconBg:'#fdcb6e', category:'security', tag:'Popular' },
  { id:'word-counter', name:'Word Counter', desc:'Count words, characters, sentences and estimate reading time.', icon:'üìù', iconBg:'#a29bfe', category:'text', tag:'Useful' },
  { id:'case-converter', name:'Text Case Converter', desc:'Transform between UPPERCASE, lowercase, Title Case and more.', icon:'Aa', iconBg:'#00cec9', category:'text', tag:'' },
  { id:'lorem-gen', name:'Lorem Ipsum Generator', desc:'Generate placeholder text for prototypes and designs.', icon:'üìÑ', iconBg:'#636e72', category:'text', tag:'' },
  { id:'json-formatter', name:'JSON Formatter', desc:'Format, validate and minify JSON with syntax highlighting.', icon:'{ }', iconBg:'#6c5ce7', category:'dev', tag:'Popular' },
  { id:'base64', name:'Base64 Encode/Decode', desc:'Convert text to/from Base64 encoding.', icon:'üîê', iconBg:'#e84393', category:'dev', tag:'' },
  { id:'markdown-preview', name:'Markdown Preview', desc:'Write Markdown and see it rendered in real time.', icon:'üìã', iconBg:'#2d3436', category:'text', tag:'' },
  { id:'calc-bmi', name:'BMI Calculator', desc:'Calculate your Body Mass Index and see your classification.', icon:'‚öñÔ∏è', iconBg:'#00b894', category:'calc', tag:'Health' },
  { id:'calc-interest', name:'Compound Interest', desc:'Simulate compound interest with monthly contributions.', icon:'üí∞', iconBg:'#fdcb6e', category:'calc', tag:'Finance' },
  { id:'calc-percent', name:'Percentage Calculator', desc:'Calculate percentages, increases, discounts and variations.', icon:'%', iconBg:'#0984e3', category:'calc', tag:'' },
  { id:'hash-gen', name:'Hash Generator', desc:'Generate SHA-256 and SHA-1 hashes from any text.', icon:'#Ô∏è‚É£', iconBg:'#e17055', category:'security', tag:'' },
  { id:'unit-converter', name:'Unit Converter', desc:'Convert between units of length, weight, temperature and volume.', icon:'üìê', iconBg:'#a29bfe', category:'calc', tag:'Useful' },
  { id:'regex-tester', name:'Regex Tester', desc:'Test regular expressions in real time with match highlighting.', icon:'.*', iconBg:'#fd79a8', category:'dev', tag:'' },
  { id:'audio-speed', name:'Audio Speed Changer', desc:'Speed up or slow down audio with pitch-preserving Phase Vocoder.', icon:'‚è©', iconBg:'#e84393', category:'audio', tag:'Popular' },
  { id:'audio-stems', name:'Vocal/Instrument Separator', desc:'Isolate vocals or instruments using multi-band spectral processing.', icon:'üé§', iconBg:'#00b894', category:'audio', tag:'New' },
  { id:'audio-reverb', name:'Audio Effects', desc:'Add reverb, echo, fade in/out, reverse and distortion to audio.', icon:'üéõÔ∏è', iconBg:'#0984e3', category:'audio', tag:'New' },
  { id:'photo-filters', name:'Photo Filters', desc:'Apply Instagram-style filters: Sepia, Vintage, B&W, Warm, Cold, Dramatic and more.', icon:'üåÖ', iconBg:'#e84393', category:'image', tag:'Popular' },
  { id:'img-adjust', name:'Image Adjustments', desc:'Fine-tune brightness, contrast, saturation, temperature, shadows, sharpness and blur.', icon:'üîß', iconBg:'#6c5ce7', category:'image', tag:'New' },
  { id:'crop-rotate', name:'Crop & Rotate', desc:'Crop images freely or with presets (16:9, 4:3, 1:1) and rotate to any angle.', icon:'‚úÇÔ∏è', iconBg:'#00b894', category:'image', tag:'New' },
  { id:'add-text', name:'Add Text to Image', desc:'Overlay text with custom fonts, colors, sizes, shadows and positioning.', icon:'‚úèÔ∏è', iconBg:'#fdcb6e', category:'image', tag:'New' },
  { id:'collage', name:'Collage Maker', desc:'Combine multiple images into beautiful grid layouts.', icon:'üß©', iconBg:'#0984e3', category:'image', tag:'New' },
  { id:'creative-fx', name:'Creative Effects', desc:'Apply Pixelate, Glitch, Posterize, Duotone and other artistic effects.', icon:'üé≠', iconBg:'#fd79a8', category:'image', tag:'New' },
  { id:'remove-bg', name:'Remove Background', desc:'Remove image background using color threshold detection.', icon:'üñºÔ∏è', iconBg:'#e17055', category:'image', tag:'Popular' },
  { id:'screenshot-beautify', name:'Screenshot Beautifier', desc:'Add gradient backgrounds, padding, shadows and rounded corners to screenshots.', icon:'üì∏', iconBg:'#a29bfe', category:'image', tag:'New' },
  { id:'pdf-tools', name:'PDF Tools', desc:'Merge, split, compress PDFs and convert images to PDF ‚Äî all in your browser.', icon:'üìÑ', iconBg:'#e74c3c', category:'text', tag:'Popular' },
  { id:'date-tools', name:'Date & Time Tools', desc:'Unix timestamp converter, age calculator, date difference and countdown timer.', icon:'‚è±Ô∏è', iconBg:'#2ecc71', category:'calc', tag:'Popular' },
  { id:'currency', name:'Currency Converter', desc:'Convert between 150+ currencies with live exchange rates updated daily.', icon:'üí±', iconBg:'#f39c12', category:'calc', tag:'Popular' },
  { id:'ip-lookup', name:'What Is My IP', desc:'Find your public IP address, location, ISP and connection details instantly.', icon:'üîç', iconBg:'#3498db', category:'dev', tag:'Popular' },
  { id:'text-diff', name:'Text Compare / Diff', desc:'Compare two texts side by side and highlight differences instantly.', icon:'üìù', iconBg:'#9b59b6', category:'text', tag:'Useful' },
  { id:'gradient-gen', name:'CSS Gradient Generator', desc:'Create beautiful CSS gradients with visual editor and copy-ready code.', icon:'üé®', iconBg:'#e84393', category:'dev', tag:'New' },
  { id:'pomodoro', name:'Pomodoro Timer', desc:'Stay focused with the Pomodoro technique ‚Äî 25min work, 5min break cycles.', icon:'‚è≤Ô∏è', iconBg:'#e17055', category:'calc', tag:'Popular' },
  { id:'url-tools', name:'URL Shortener & Encoder', desc:'Encode/decode URLs, extract parameters, and generate QR codes from any link.', icon:'üîó', iconBg:'#00b894', category:'dev', tag:'Useful' },
];

// Slug map: tool id ‚Üí SEO page URL
const slugMap = {'img-compress':'compress-image','img-resize':'resize-image','img-convert':'image-converter','photo-filters':'photo-filters','img-adjust':'image-adjustments','crop-rotate':'crop-rotate','add-text':'add-text-to-image','collage':'collage-maker','creative-fx':'creative-effects','remove-bg':'remove-background','screenshot-beautify':'screenshot-beautifier','word-count':'word-counter','case-convert':'case-converter','lorem-gen':'lorem-ipsum-generator','json-format':'json-formatter','base64':'base64-encoder-decoder','markdown':'markdown-preview','qrcode':'qr-code-generator','password-gen':'password-generator','hash-gen':'hash-generator','unit-converter':'unit-converter','regex-test':'regex-tester','color-picker':'color-picker','audio-speed':'audio-speed-changer','audio-fx':'audio-effects','stem-split':'stem-separator','audio-record':'audio-recorder','pdf-tools':'merge-pdf','date-tools':'date-tools','currency':'currency-converter','ip-lookup':'what-is-my-ip','text-diff':'text-diff','gradient-gen':'css-gradient-generator','pomodoro':'pomodoro-timer','url-tools':'url-tools','calculator':'calculator'};

function renderTools(filtered) {
  const grid = document.getElementById('toolsGrid');
  (filtered || tools).forEach(() => {}); // just to reference
  grid.innerHTML = (filtered || tools).map(t => {
    const slug = slugMap[t.id];
    const href = slug ? '/' + slug : '#';
    return `<a href="${href}" class="tool-card" data-category="${t.category}" style="text-decoration:none;color:inherit" onclick="if(!slugMap['${t.id}']){event.preventDefault();openTool('${t.id}')}">
      <div class="tool-icon" style="background:${t.iconBg}22;color:${t.iconBg}">${t.icon}</div>
      <h3>${t.name}</h3><p>${t.desc}</p>
      ${t.tag ? `<span class="tool-tag">${t.tag}</span>` : ''}
    </a>`}).join('');
}
renderTools();

function filterCategory(cat, btn) {
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
  if(btn) btn.classList.add('active');
  if (cat === 'all') return renderTools();
  renderTools(tools.filter(t => t.category === cat));
}
function filterTools() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  if (!q) return renderTools();
  renderTools(tools.filter(t => t.name.toLowerCase().includes(q) || t.desc.toLowerCase().includes(q)));
}
function openTool(id) {
  document.getElementById('modalContent').innerHTML = getToolHTML(id);
  document.getElementById('modalOverlay').classList.add('active');
  document.body.style.overflow = 'hidden';
  if (id === 'qrcode') setTimeout(initQR, 100);
  if (id === 'password-gen') generatePassword();
  if (id === 'color-picker') setTimeout(() => renderColor('#6c5ce7'), 50);
  if (id === 'unit-converter') updateUnits();
  if (toolInits[id]) setTimeout(toolInits[id], 100);
}
function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
  document.body.style.overflow = '';
}
function showToast(msg) { const t=document.getElementById('toast'); t.textContent=msg||'Copied!'; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }
function copyText(text) { navigator.clipboard.writeText(text).then(()=>showToast()); }
function formatBytes(b) { if(!b) return '0 B'; const k=1024,s=['B','KB','MB','GB']; const i=Math.floor(Math.log(b)/Math.log(k)); return parseFloat((b/Math.pow(k,i)).toFixed(1))+' '+s[i]; }

// =====================================================
// TOOL HTML TEMPLATES
// =====================================================
function getToolHTML(id) {
  const close = `<button class="modal-close" onclick="closeModal()">‚úï</button>`;
  const upload = (inputId, fn, extra) => `<div class="drop-zone" onclick="document.getElementById('${inputId}').click()">
    <svg width="40" height="40" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path d="M12 16V4m0 0L8 8m4-4l4 4M4 17v2a1 1 0 001 1h14a1 1 0 001-1v-2"/></svg>
    <p>Click to choose a file</p>${extra||''}
    <input type="file" id="${inputId}" accept="${fn}" hidden>
  </div>`;

  switch(id) {
    case 'compress-img': return `${close}<h2>üì¶ Compress Image</h2><p class="subtitle">Reduce file size without visible quality loss</p>
      ${upload('fileInput','image/*')}
      <div class="form-group"><label>Quality</label><div class="slider-group"><input type="range" min="10" max="100" value="75" id="qualitySlider" oninput="document.getElementById('qualityVal').textContent=this.value+'%'"><span class="slider-val" id="qualityVal">75%</span></div></div>
      <div class="result-area" id="compressResult"><div class="stats-row">
        <div class="stat-box"><div class="label">Original</div><div class="value" id="origSize">-</div></div>
        <div class="stat-box"><div class="label">Compressed</div><div class="value green" id="compSize">-</div></div>
        <div class="stat-box"><div class="label">Reduction</div><div class="value orange" id="reduction">-</div></div>
      </div><canvas id="compressCanvas" style="display:none"></canvas><br><button class="btn btn-primary" onclick="downloadCompressed()">‚¨á Download</button></div>`;

    case 'resize-img': return `${close}<h2>‚ÜîÔ∏è Resize Image</h2><p class="subtitle">Change image dimensions</p>
      ${upload('resizeInput','image/*')}
      <div style="display:flex;gap:12px;margin-bottom:20px">
        <div class="form-group" style="flex:1"><label>Width (px)</label><input class="form-input" type="number" id="resW" placeholder="800" oninput="lockRatio()"></div>
        <div class="form-group" style="flex:1"><label>Height (px)</label><input class="form-input" type="number" id="resH" placeholder="600" oninput="lockRatioH()"></div>
      </div>
      <div class="check-group"><label><input type="checkbox" id="keepRatio" checked> Keep aspect ratio</label></div>
      <button class="btn btn-primary" onclick="doResize()" id="resizeBtn" disabled>Resize</button>
      <div class="result-area" id="resizeResult"><canvas id="resizeCanvas" style="display:none"></canvas><p style="color:var(--green);margin-bottom:12px">‚úì Image resized!</p><button class="btn btn-primary" onclick="downloadResized()">‚¨á Download</button></div>`;

    case 'convert-img': return `${close}<h2>üîÑ Convert Image</h2><p class="subtitle">Convert between PNG, JPG, WEBP and BMP</p>
      ${upload('convInput','image/*')}
      <div class="form-group"><label>Convert to:</label><select class="form-select" id="convFormat"><option value="image/png">PNG</option><option value="image/jpeg">JPG</option><option value="image/webp">WEBP</option><option value="image/bmp">BMP</option></select></div>
      <button class="btn btn-primary" onclick="doConvert()" id="convBtn" disabled>Convert</button>
      <div class="result-area" id="convResult"><canvas id="convCanvas" style="display:none"></canvas><p style="color:var(--green);margin-bottom:12px" id="convMsg">‚úì Converted!</p><button class="btn btn-primary" onclick="downloadConverted()">‚¨á Download</button></div>`;

    case 'qrcode': return `${close}<h2>üì± QR Code Generator</h2><p class="subtitle">Create custom QR Codes</p>
      <div class="form-group"><label>Content (URL, text, etc.)</label><input class="form-input" id="qrText" placeholder="https://yoursite.com" oninput="updateQR()"></div>
      <div class="form-group"><label>Size</label><div class="slider-group"><input type="range" min="128" max="512" value="256" id="qrSize" oninput="document.getElementById('qrSizeVal').textContent=this.value+'px';updateQR()"><span class="slider-val" id="qrSizeVal">256px</span></div></div>
      <div class="form-group"><label>Color</label><input type="color" id="qrColor" value="#6c5ce7" onchange="updateQR()" style="width:48px;height:36px;border:none;background:none;cursor:pointer"></div>
      <div id="qrPreview" style="text-align:center;margin:20px 0;background:white;padding:20px;border-radius:12px;display:inline-block"></div>
      <br><button class="btn btn-primary" onclick="downloadQR()">‚¨á Download QR Code</button>`;

    case 'color-picker': return `${close}<h2>üé® Color Palette</h2><p class="subtitle">Explore and convert colors</p>
      <div class="form-group"><label>Pick a color</label><div style="display:flex;gap:12px;align-items:center"><input type="color" id="colorPick" value="#6c5ce7" oninput="updateColor()" style="width:64px;height:48px;border:none;cursor:pointer"><input class="form-input" id="hexInput" value="#6c5ce7" style="width:140px" oninput="updateFromHex()"></div></div>
      <div style="width:100%;height:80px;border-radius:12px;margin-bottom:20px;transition:background .3s" id="colorPreview"></div>
      <div class="stats-row" id="colorValues"></div>
      <div class="form-group" style="margin-top:20px"><label>Harmonic Palette</label></div><div id="harmonicPalette" style="display:flex;gap:8px;flex-wrap:wrap"></div>`;

    case 'password-gen': return `${close}<h2>üîë Password Generator</h2><p class="subtitle">Create secure, customizable passwords</p>
      <div class="password-display" id="pwdDisplay" onclick="copyText(this.textContent)">-</div>
      <div class="strength-bar"><div class="strength-fill" id="strengthFill"></div></div>
      <p style="font-size:12px;color:var(--text2);margin-bottom:20px;text-align:center" id="strengthText">-</p>
      <div class="form-group"><label>Length</label><div class="slider-group"><input type="range" min="6" max="64" value="16" id="pwdLen" oninput="document.getElementById('pwdLenVal').textContent=this.value;generatePassword()"><span class="slider-val" id="pwdLenVal">16</span></div></div>
      <div class="check-group"><label><input type="checkbox" id="pwdUpper" checked onchange="generatePassword()"> ABC</label><label><input type="checkbox" id="pwdLower" checked onchange="generatePassword()"> abc</label><label><input type="checkbox" id="pwdNumbers" checked onchange="generatePassword()"> 123</label><label><input type="checkbox" id="pwdSymbols" checked onchange="generatePassword()"> !@#</label></div>
      <button class="btn btn-primary" onclick="generatePassword()">üîÑ Generate New</button><button class="btn btn-secondary" style="margin-left:8px" onclick="copyText(document.getElementById('pwdDisplay').textContent)">üìã Copy</button>`;

    case 'word-counter': return `${close}<h2>üìù Word Counter</h2><p class="subtitle">Complete text analysis</p>
      <textarea class="form-textarea" id="wcText" rows="8" placeholder="Paste or type your text here..." oninput="countWords()"></textarea>
      <div class="stats-row" style="margin-top:16px"><div class="stat-box"><div class="label">Characters</div><div class="value" id="wcChars">0</div></div><div class="stat-box"><div class="label">Words</div><div class="value" id="wcWords">0</div></div><div class="stat-box"><div class="label">Sentences</div><div class="value" id="wcSentences">0</div></div><div class="stat-box"><div class="label">Paragraphs</div><div class="value" id="wcParas">0</div></div></div>
      <div class="stats-row"><div class="stat-box"><div class="label">Reading time</div><div class="value" id="wcRead">0 min</div></div><div class="stat-box"><div class="label">Speaking time</div><div class="value" id="wcSpeak">0 min</div></div></div>`;

    case 'case-converter': return `${close}<h2>Aa Text Case Converter</h2><p class="subtitle">Transform text between different formats</p>
      <textarea class="form-textarea" id="caseText" rows="5" placeholder="Paste your text here..."></textarea>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:16px"><button class="btn btn-secondary" onclick="convertCase('upper')">UPPER</button><button class="btn btn-secondary" onclick="convertCase('lower')">lower</button><button class="btn btn-secondary" onclick="convertCase('title')">Title Case</button><button class="btn btn-secondary" onclick="convertCase('sentence')">Sentence case</button><button class="btn btn-secondary" onclick="convertCase('toggle')">tOGGLE</button><button class="btn btn-secondary" onclick="convertCase('slug')">slug-format</button></div>
      <div class="form-group" style="margin-top:20px"><label>Result</label></div><textarea class="form-textarea" id="caseResult" rows="5" readonly></textarea><button class="btn btn-primary" style="margin-top:12px" onclick="copyText(document.getElementById('caseResult').value)">üìã Copy</button>`;

    case 'lorem-gen': return `${close}<h2>üìÑ Lorem Ipsum Generator</h2><p class="subtitle">Placeholder text for your projects</p>
      <div style="display:flex;gap:12px;margin-bottom:20px"><div class="form-group" style="flex:1"><label>Amount</label><input class="form-input" type="number" id="loremCount" value="3" min="1" max="50"></div><div class="form-group" style="flex:1"><label>Type</label><select class="form-select" id="loremType"><option value="paragraphs">Paragraphs</option><option value="sentences">Sentences</option><option value="words">Words</option></select></div></div>
      <button class="btn btn-primary" onclick="genLorem()">Generate</button><div class="form-group" style="margin-top:20px"><label>Result</label></div><textarea class="form-textarea" id="loremResult" rows="8" readonly></textarea><button class="btn btn-secondary" style="margin-top:12px" onclick="copyText(document.getElementById('loremResult').value)">üìã Copy</button>`;

    case 'json-formatter': return `${close}<h2>{ } JSON Formatter</h2><p class="subtitle">Format, validate and minify JSON</p>
      <textarea class="form-textarea" id="jsonInput" rows="8" placeholder='{"name":"John","age":25}'></textarea>
      <div style="display:flex;gap:8px;margin-top:16px"><button class="btn btn-primary" onclick="formatJSON()">‚ú® Format</button><button class="btn btn-secondary" onclick="minifyJSON()">üì¶ Minify</button><button class="btn btn-secondary" onclick="copyText(document.getElementById('jsonOutput').textContent)">üìã Copy</button></div>
      <div class="result-area active" style="margin-top:16px"><pre id="jsonOutput" style="color:var(--accent2);white-space:pre-wrap;word-break:break-all;font-size:13px;"></pre></div>`;

    case 'base64': return `${close}<h2>üîê Base64 Encode/Decode</h2><p class="subtitle">Convert text to/from Base64</p>
      <div class="tabs"><button class="tab-btn active" onclick="b64Mode='encode';document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active')">Encode</button><button class="tab-btn" onclick="b64Mode='decode';document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));this.classList.add('active')">Decode</button></div>
      <textarea class="form-textarea" id="b64Input" rows="5" placeholder="Type text here..."></textarea><button class="btn btn-primary" style="margin-top:12px" onclick="doBase64()">Convert</button>
      <div class="form-group" style="margin-top:20px"><label>Result</label></div><textarea class="form-textarea" id="b64Output" rows="5" readonly></textarea><button class="btn btn-secondary" style="margin-top:12px" onclick="copyText(document.getElementById('b64Output').value)">üìã Copy</button>`;

    case 'markdown-preview': return `${close}<h2>üìã Markdown Preview</h2><p class="subtitle">Live Markdown rendering</p>
      <textarea class="form-textarea" id="mdInput" rows="10" placeholder="# Title\n\nWrite your **markdown** here..." oninput="updateMD()"></textarea>
      <div class="form-group" style="margin-top:20px"><label>Preview</label></div><div class="preview-box" id="mdPreview"></div>`;

    case 'calc-bmi': return `${close}<h2>‚öñÔ∏è BMI Calculator</h2><p class="subtitle">Body Mass Index</p>
      <div style="display:flex;gap:12px"><div class="form-group" style="flex:1"><label>Weight (kg)</label><input class="form-input" type="number" id="bmiW" placeholder="70"></div><div class="form-group" style="flex:1"><label>Height (cm)</label><input class="form-input" type="number" id="bmiH" placeholder="170"></div></div>
      <button class="btn btn-primary" onclick="calcBMI()">Calculate</button><div class="result-area" id="bmiResult"></div>`;

    case 'calc-interest': return `${close}<h2>üí∞ Compound Interest Calculator</h2><p class="subtitle">Simulate your investments</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap"><div class="form-group" style="flex:1;min-width:150px"><label>Initial Capital ($)</label><input class="form-input" type="number" id="jCap" value="1000"></div><div class="form-group" style="flex:1;min-width:150px"><label>Monthly Contribution ($)</label><input class="form-input" type="number" id="jAdd" value="200"></div></div>
      <div style="display:flex;gap:12px;flex-wrap:wrap"><div class="form-group" style="flex:1;min-width:150px"><label>Interest Rate (% per month)</label><input class="form-input" type="number" id="jRate" value="1" step="0.01"></div><div class="form-group" style="flex:1;min-width:150px"><label>Period (months)</label><input class="form-input" type="number" id="jMonths" value="12"></div></div>
      <button class="btn btn-primary" onclick="calcInterest()">Calculate</button><div class="result-area" id="interestResult"></div>`;

    case 'calc-percent': return `${close}<h2>% Percentage Calculator</h2><p class="subtitle">Quick percentage calculations</p>
      <div class="form-group"><label>What is <input class="form-input" type="number" id="percA" style="width:100px;display:inline"> % of <input class="form-input" type="number" id="percB" style="width:100px;display:inline"> ?</label></div>
      <button class="btn btn-primary" onclick="calcPercent()" style="margin-bottom:20px">Calculate</button><div class="result-area" id="percResult"></div>
      <hr style="border-color:var(--border);margin:24px 0">
      <div class="form-group"><label>Variation: from <input class="form-input" type="number" id="percFrom" style="width:100px;display:inline"> to <input class="form-input" type="number" id="percTo" style="width:100px;display:inline"></label></div>
      <button class="btn btn-secondary" onclick="calcVariation()">Calculate Variation</button><div class="result-area" id="varResult" style="margin-top:12px"></div>`;

    case 'hash-gen': return `${close}<h2>#Ô∏è‚É£ Hash Generator</h2><p class="subtitle">Generate cryptographic hashes</p>
      <textarea class="form-textarea" id="hashInput" rows="4" placeholder="Type text to hash..." oninput="genHash()"></textarea>
      <div class="stats-row" style="margin-top:16px;flex-direction:column;gap:12px">
        <div class="stat-box" style="cursor:pointer" onclick="copyText(document.getElementById('hashSHA256').textContent)"><div class="label">SHA-256</div><div class="value" style="font-size:13px;word-break:break-all;font-family:monospace" id="hashSHA256">-</div></div>
        <div class="stat-box" style="cursor:pointer" onclick="copyText(document.getElementById('hashSHA1').textContent)"><div class="label">SHA-1</div><div class="value" style="font-size:13px;word-break:break-all;font-family:monospace" id="hashSHA1">-</div></div>
      </div><p style="font-size:12px;color:var(--text2);margin-top:12px">Click any hash to copy</p>`;

    case 'unit-converter': return `${close}<h2>üìê Unit Converter</h2><p class="subtitle">Convert between different units of measurement</p>
      <div class="form-group"><label>Category</label><select class="form-select" id="unitCat" onchange="updateUnits()"><option value="length">Length</option><option value="weight">Weight / Mass</option><option value="temperature">Temperature</option><option value="volume">Volume</option><option value="data">Data / Storage</option></select></div>
      <div style="display:flex;gap:12px;align-items:end"><div class="form-group" style="flex:1"><label>Value</label><input class="form-input" type="number" id="unitVal" value="1" oninput="convertUnit()"></div><div class="form-group" style="flex:1"><label>From</label><select class="form-select" id="unitFrom" onchange="convertUnit()"></select></div><div class="form-group" style="flex:1"><label>To</label><select class="form-select" id="unitTo" onchange="convertUnit()"></select></div></div>
      <div class="result-area active" id="unitResult" style="text-align:center"><span style="font-size:32px;font-weight:700" id="unitOutput">-</span></div>`;

    case 'regex-tester': return `${close}<h2>.* Regex Tester</h2><p class="subtitle">Test regular expressions in real time</p>
      <div style="display:flex;gap:12px"><div class="form-group" style="flex:1"><label>Regular Expression</label><input class="form-input" id="regexExpr" placeholder="\\d+" oninput="testRegex()"></div><div class="form-group" style="width:100px"><label>Flags</label><input class="form-input" id="regexFlags" value="gi" oninput="testRegex()"></div></div>
      <textarea class="form-textarea" id="regexText" rows="5" placeholder="Text to test against..." oninput="testRegex()"></textarea>
      <div class="result-area active" style="margin-top:16px"><div class="label" style="margin-bottom:8px">Matches:</div><div id="regexMatches" style="font-family:monospace;font-size:14px;line-height:2"></div><p style="font-size:12px;color:var(--text2);margin-top:12px" id="regexCount">0 matches</p></div>`;

    // ====== AUDIO SPEED (Phase Vocoder) ======
    case 'audio-speed': return `${close}<h2>‚è© Audio Speed Changer</h2><p class="subtitle">Speed up or slow down audio with pitch preservation</p>
      ${AUDIO_DISCLAIMER}
      ${upload('audioSpeedInput','audio/*','<p style="font-size:12px;margin-top:4px;color:var(--text2)">MP3, WAV, OGG, M4A</p>')}
      <div id="audioSpeedStatus" style="padding:8px 0;font-size:13px;color:var(--text2)"></div>
      <div id="audioSpeedLoaded" style="display:none">
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px">
          <p style="font-size:13px;color:var(--text2);margin-bottom:8px" id="audioSpeedName"></p>
          <audio id="audioSpeedPlayer" controls style="width:100%;height:40px"></audio>
        </div>
        <div class="form-group"><label>Speed: <strong id="speedValLabel">1.00x</strong></label>
          <div class="slider-group"><span style="font-size:12px;color:var(--text2)">0.25x</span><input type="range" min="0.25" max="3" step="0.05" value="1" id="speedSlider" oninput="changeSpeed()"><span style="font-size:12px;color:var(--text2)">3.0x</span></div>
          <div style="display:flex;gap:6px;margin-top:10px;flex-wrap:wrap">
            <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(0.5)">0.5x</button><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(0.75)">0.75x</button><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(1)">1.0x</button><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(1.25)">1.25x</button><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(1.5)">1.5x</button><button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setSpeed(2)">2.0x</button>
          </div>
        </div>
        <div class="check-group"><label><input type="checkbox" id="preservePitch" checked onchange="changeSpeed()"> Preserve pitch (recommended)</label></div>
        <button class="btn btn-primary" id="exportSpeedBtn" onclick="exportAudioSpeed()">‚¨á Export Modified Audio</button>
        <div id="audioSpeedProcessing" style="display:none;text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--text2)">Processing with Phase Vocoder...</p></div>
        <div class="result-area" id="audioSpeedResult"><p style="color:var(--green);margin-bottom:12px">‚úì Audio exported successfully!</p><audio id="audioSpeedExported" controls style="width:100%;height:40px"></audio><br><br><a id="audioSpeedDownload" class="btn btn-primary" download="audio_speed.wav">‚¨á Download WAV</a></div>
      </div>`;

    // ====== STEM SEPARATOR (Improved local + external links) ======
    case 'audio-stems': return `${close}<h2>üé§ Vocal / Instrument Separator</h2><p class="subtitle">Isolate vocals or instruments from any song</p>
      <div class="audio-disclaimer">
        <strong>üéµ Two ways to separate audio:</strong><br><br>
        <strong>üîí Built-in (Free, Private)</strong> ‚Äî Processes entirely in your browser using advanced spectral algorithms. Good for basic isolation, especially on songs with centered vocals. No upload needed.<br><br>
        <strong>ü§ñ AI Services (Best Quality)</strong> ‚Äî For professional-grade separation, try these free AI-powered tools:
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <a href="https://vocalremover.org/" target="_blank" class="btn btn-secondary" style="padding:6px 14px;font-size:12px;text-decoration:none">üé§ VocalRemover.org</a>
          <a href="https://www.lalal.ai/" target="_blank" class="btn btn-secondary" style="padding:6px 14px;font-size:12px;text-decoration:none">üéµ LALAL.ai</a>
          <a href="https://moises.ai/" target="_blank" class="btn btn-secondary" style="padding:6px 14px;font-size:12px;text-decoration:none">üé∏ Moises.ai</a>
          <a href="https://soundboost.ai/free-vocal-remover-stem-splitter" target="_blank" class="btn btn-secondary" style="padding:6px 14px;font-size:12px;text-decoration:none">üîä SoundBoost</a>
        </div>
      </div>
      ${upload('stemInput','audio/*')}
      <div id="stemStatus" style="padding:8px 0;font-size:13px;color:var(--text2)"></div>
      <div id="stemLoaded" style="display:none">
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px">
          <p style="font-size:13px;color:var(--text2);margin-bottom:8px" id="stemFileName"></p>
          <audio id="stemOrigPlayer" controls style="width:100%;height:40px"></audio>
        </div>
        <div class="form-group"><label>Separation Target</label><select class="form-select" id="stemMode">
          <option value="vocals">üé§ Isolate Vocals</option><option value="instrumental">üé∏ Remove Vocals (Instrumental)</option><option value="bass">üéµ Isolate Bass</option><option value="treble">üîî Isolate Treble</option>
        </select></div>
        <div class="form-group"><label>Intensity: <strong id="stemIntVal">5</strong></label><div class="slider-group"><span style="font-size:12px;color:var(--text2)">Gentle</span><input type="range" min="1" max="10" step="1" value="5" id="stemIntensity" oninput="document.getElementById('stemIntVal').textContent=this.value"><span style="font-size:12px;color:var(--text2)">Strong</span></div></div>
        <button class="btn btn-primary" onclick="processStem()" id="stemProcessBtn">üéµ Process Audio</button>
        <div id="stemProcessing" style="display:none;text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--text2)" id="stemProgressText">Processing...</p></div>
        <div class="result-area" id="stemResult"><p style="color:var(--green);margin-bottom:12px" id="stemResultMsg">‚úì Done!</p><audio id="stemExportPlayer" controls style="width:100%;height:40px"></audio><br><br><a id="stemDownload" class="btn btn-primary" download="separated.wav">‚¨á Download WAV</a></div>
      </div>`;

    // ====== AUDIO EFFECTS ======
    case 'audio-reverb': return `${close}<h2>üéõÔ∏è Audio Effects</h2><p class="subtitle">Add effects to your audio files</p>
      ${AUDIO_DISCLAIMER}
      ${upload('fxInput','audio/*')}
      <div id="fxStatus" style="padding:8px 0;font-size:13px;color:var(--text2)"></div>
      <div id="fxLoaded" style="display:none">
        <div style="background:var(--surface2);border-radius:var(--radius-sm);padding:16px;margin-bottom:20px">
          <p style="font-size:13px;color:var(--text2);margin-bottom:8px" id="fxFileName"></p>
          <audio id="fxOrigPlayer" controls style="width:100%;height:40px"></audio>
        </div>
        <div class="form-group"><label>Effect</label><select class="form-select" id="fxType" onchange="updateFxUI()"><option value="fadein">üîä Fade In</option><option value="fadeout">üîá Fade Out</option><option value="reverse">‚è™ Reverse</option><option value="reverb">üèõÔ∏è Reverb</option><option value="delay">üì¢ Delay / Echo</option><option value="distortion">üé∏ Distortion</option></select></div>
        <div class="form-group" id="fxAmountGroup" style="display:none"><label>Intensity: <strong id="fxAmountLabel">50%</strong></label><div class="slider-group"><input type="range" min="10" max="100" value="50" id="fxAmount" oninput="document.getElementById('fxAmountLabel').textContent=this.value+'%'"></div></div>
        <div class="form-group" id="fxDurationGroup"><label>Fade duration (seconds): <strong id="fxDurLabel">2</strong></label><div class="slider-group"><input type="range" min="0.5" max="10" step="0.5" value="2" id="fxDuration" oninput="document.getElementById('fxDurLabel').textContent=this.value"></div></div>
        <button class="btn btn-primary" onclick="processFx()" id="fxProcessBtn">üéõÔ∏è Apply Effect</button>
        <div id="fxProcessing" style="display:none;text-align:center;padding:20px"><div class="spinner"></div><p style="color:var(--text2)">Applying effect...</p></div>
        <div class="result-area" id="fxResult"><p style="color:var(--green);margin-bottom:12px">‚úì Effect applied!</p><audio id="fxExportPlayer" controls style="width:100%;height:40px"></audio><br><br><a id="fxDownload" class="btn btn-primary" download="effect_audio.wav">‚¨á Download WAV</a></div>
      </div>`;

    // ====== PHOTO FILTERS ======
    case 'photo-filters': return `${close}<h2>üåÖ Photo Filters</h2><p class="subtitle">Apply beautiful Instagram-style filters to your photos</p>
      ${upload('pfInput','image/*')}
      <div id="pfLoaded" style="display:none">
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px" id="pfFilterBtns"></div>
        <canvas id="pfCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)"></canvas>
        <div style="margin-top:16px;display:flex;gap:8px">
          <button class="btn btn-secondary" onclick="applyPhotoFilter('none')">‚Ü© Reset</button>
          <button class="btn btn-primary" onclick="downloadCanvas('pfCanvas','filtered_photo.png')">‚¨á Download</button>
        </div>
      </div>`;

    // ====== IMAGE ADJUSTMENTS ======
    case 'img-adjust': return `${close}<h2>üîß Image Adjustments</h2><p class="subtitle">Fine-tune your image with professional controls</p>
      ${upload('adjInput','image/*')}
      <div id="adjLoaded" style="display:none">
        <canvas id="adjCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border);margin-bottom:16px"></canvas>
        <div class="form-group"><label>Brightness</label><div class="slider-group"><input type="range" min="-100" max="100" value="0" id="adjBright" oninput="applyAdj()"><span class="slider-val" id="adjBrightV">0</span></div></div>
        <div class="form-group"><label>Contrast</label><div class="slider-group"><input type="range" min="-100" max="100" value="0" id="adjContrast" oninput="applyAdj()"><span class="slider-val" id="adjContrastV">0</span></div></div>
        <div class="form-group"><label>Saturation</label><div class="slider-group"><input type="range" min="-100" max="100" value="0" id="adjSat" oninput="applyAdj()"><span class="slider-val" id="adjSatV">0</span></div></div>
        <div class="form-group"><label>Temperature</label><div class="slider-group"><input type="range" min="-50" max="50" value="0" id="adjTemp" oninput="applyAdj()"><span class="slider-val" id="adjTempV">0</span></div></div>
        <div class="form-group"><label>Blur</label><div class="slider-group"><input type="range" min="0" max="20" value="0" id="adjBlur" oninput="applyAdj()"><span class="slider-val" id="adjBlurV">0</span></div></div>
        <div class="form-group"><label>Vignette</label><div class="slider-group"><input type="range" min="0" max="100" value="0" id="adjVig" oninput="applyAdj()"><span class="slider-val" id="adjVigV">0</span></div></div>
        <div style="display:flex;gap:8px"><button class="btn btn-secondary" onclick="resetAdj()">‚Ü© Reset All</button><button class="btn btn-primary" onclick="downloadCanvas('adjCanvas','adjusted.png')">‚¨á Download</button></div>
      </div>`;

    // ====== CROP & ROTATE ======
    case 'crop-rotate': return `${close}<h2>‚úÇÔ∏è Crop & Rotate</h2><p class="subtitle">Crop and rotate your images with precision</p>
      ${upload('cropInput','image/*')}
      <div id="cropLoaded" style="display:none">
        <div class="form-group"><label>Rotation: <strong id="rotValLabel">0¬∞</strong></label><div class="slider-group"><input type="range" min="-180" max="180" value="0" id="rotSlider" oninput="updateCropPreview()"></div></div>
        <div class="form-group"><label>Aspect Ratio</label><div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setCropRatio('free')">Free</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setCropRatio(1)">1:1</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setCropRatio(16/9)">16:9</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setCropRatio(4/3)">4:3</button>
          <button class="btn btn-secondary" style="padding:6px 12px;font-size:12px" onclick="setCropRatio(9/16)">9:16</button>
        </div></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
          <div class="form-group" style="flex:1;min-width:70px"><label>X</label><input class="form-input" type="number" id="cropX" value="0" oninput="updateCropPreview()"></div>
          <div class="form-group" style="flex:1;min-width:70px"><label>Y</label><input class="form-input" type="number" id="cropY" value="0" oninput="updateCropPreview()"></div>
          <div class="form-group" style="flex:1;min-width:70px"><label>Width</label><input class="form-input" type="number" id="cropW" oninput="updateCropPreview()"></div>
          <div class="form-group" style="flex:1;min-width:70px"><label>Height</label><input class="form-input" type="number" id="cropH" oninput="updateCropPreview()"></div>
        </div>
        <canvas id="cropCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)"></canvas>
        <div style="margin-top:16px;display:flex;gap:8px"><button class="btn btn-primary" onclick="doCrop()">‚úÇ Crop & Export</button></div>
        <div class="result-area" id="cropResult"><p style="color:var(--green);margin-bottom:12px">‚úì Cropped!</p><canvas id="cropOut" style="max-width:100%;border-radius:8px"></canvas><br><br><button class="btn btn-primary" onclick="downloadCanvas('cropOut','cropped.png')">‚¨á Download</button></div>
      </div>`;

    // ====== ADD TEXT ======
    case 'add-text': return `${close}<h2>‚úèÔ∏è Add Text to Image</h2><p class="subtitle">Overlay text with custom styling</p>
      ${upload('textImgInput','image/*')}
      <div id="textImgLoaded" style="display:none">
        <div class="form-group"><label>Text</label><input class="form-input" id="txtContent" value="Hello World" oninput="drawTextPreview()"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
          <div class="form-group" style="flex:1;min-width:120px"><label>Font</label><select class="form-select" id="txtFont" onchange="drawTextPreview()"><option>Arial</option><option>Georgia</option><option>Courier New</option><option>Impact</option><option>Verdana</option><option>Trebuchet MS</option><option>Comic Sans MS</option><option>Times New Roman</option></select></div>
          <div class="form-group" style="flex:1;min-width:90px"><label>Size</label><input class="form-input" type="number" id="txtSize" value="48" oninput="drawTextPreview()"></div>
          <div class="form-group" style="width:60px"><label>Color</label><input type="color" id="txtColor" value="#ffffff" oninput="drawTextPreview()" style="width:48px;height:36px;border:none;cursor:pointer"></div>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
          <div class="form-group" style="flex:1"><label>X Position</label><div class="slider-group"><input type="range" min="0" max="100" value="50" id="txtX" oninput="drawTextPreview()"></div></div>
          <div class="form-group" style="flex:1"><label>Y Position</label><div class="slider-group"><input type="range" min="0" max="100" value="50" id="txtY" oninput="drawTextPreview()"></div></div>
        </div>
        <div class="check-group"><label><input type="checkbox" id="txtShadow" checked onchange="drawTextPreview()"> Drop shadow</label><label><input type="checkbox" id="txtBold" onchange="drawTextPreview()"> Bold</label></div>
        <canvas id="textCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)"></canvas>
        <div style="margin-top:16px"><button class="btn btn-primary" onclick="downloadCanvas('textCanvas','text_image.png')">‚¨á Download</button></div>
      </div>`;

    // ====== COLLAGE MAKER ======
    case 'collage': return `${close}<h2>üß© Collage Maker</h2><p class="subtitle">Combine multiple images into a grid</p>
      <div class="form-group"><label>Upload images (2-6)</label><input type="file" id="collageInput" accept="image/*" multiple class="form-input" style="padding:12px"></div>
      <div class="form-group"><label>Layout</label><select class="form-select" id="collageLayout"><option value="2x1">2 Side by Side</option><option value="1x2">2 Stacked</option><option value="2x2">2√ó2 Grid</option><option value="3x1">3 Columns</option><option value="3x2">3√ó2 Grid</option></select></div>
      <div class="form-group"><label>Gap (px)</label><div class="slider-group"><input type="range" min="0" max="20" value="4" id="collageGap"><span class="slider-val">4</span></div></div>
      <div class="form-group"><label>Background</label><input type="color" id="collageBg" value="#000000" style="width:48px;height:36px;border:none;cursor:pointer"></div>
      <button class="btn btn-primary" onclick="makeCollage()">üß© Create Collage</button>
      <div class="result-area" id="collageResult"><canvas id="collageCanvas" style="max-width:100%;border-radius:8px"></canvas><br><br><button class="btn btn-primary" onclick="downloadCanvas('collageCanvas','collage.png')">‚¨á Download</button></div>`;

    // ====== CREATIVE EFFECTS ======
    case 'creative-fx': return `${close}<h2>üé≠ Creative Effects</h2><p class="subtitle">Apply artistic effects to your images</p>
      ${upload('cfxInput','image/*')}
      <div id="cfxLoaded" style="display:none">
        <div class="form-group"><label>Effect</label><select class="form-select" id="cfxType" onchange="applyCfx()"><option value="pixelate">üü© Pixelate</option><option value="glitch">üì∫ Glitch</option><option value="posterize">üé® Posterize</option><option value="duotone">üîµ Duotone</option><option value="noise">üì° Noise</option><option value="invert">üîÑ Invert Colors</option><option value="emboss">üèîÔ∏è Emboss</option></select></div>
        <div class="form-group"><label>Intensity: <strong id="cfxIntV">50</strong>%</label><div class="slider-group"><input type="range" min="5" max="100" value="50" id="cfxInt" oninput="document.getElementById('cfxIntV').textContent=this.value;applyCfx()"></div></div>
        <div class="form-group" id="cfxDuotoneColors" style="display:none"><label>Duotone Colors</label><div style="display:flex;gap:8px"><input type="color" id="cfxDuo1" value="#6c5ce7" onchange="applyCfx()"><input type="color" id="cfxDuo2" value="#fd79a8" onchange="applyCfx()"></div></div>
        <canvas id="cfxCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)"></canvas>
        <div style="margin-top:16px;display:flex;gap:8px"><button class="btn btn-secondary" onclick="applyCfx('none')">‚Ü© Reset</button><button class="btn btn-primary" onclick="downloadCanvas('cfxCanvas','effect.png')">‚¨á Download</button></div>
      </div>`;

    // ====== REMOVE BACKGROUND ======
    case 'remove-bg': return `${close}<h2>üñºÔ∏è Remove Background</h2><p class="subtitle">Remove background using color threshold detection</p>
      <div class="audio-disclaimer"><strong>üîí Runs Locally</strong><br>This tool uses color-distance thresholding to remove backgrounds. Works best with solid-color or high-contrast backgrounds. For complex backgrounds, try <a href="https://www.remove.bg" target="_blank" style="color:var(--accent2)">remove.bg</a> (AI-powered).</div>
      ${upload('bgInput','image/*')}
      <div id="bgLoaded" style="display:none">
        <div class="form-group"><label>Click on the background color to remove, or pick manually:</label><input type="color" id="bgColor" value="#ffffff" onchange="removeBg()" style="width:48px;height:36px;border:none;cursor:pointer"></div>
        <div class="form-group"><label>Tolerance: <strong id="bgTolV">30</strong></label><div class="slider-group"><input type="range" min="1" max="100" value="30" id="bgTol" oninput="document.getElementById('bgTolV').textContent=this.value;removeBg()"></div></div>
        <canvas id="bgCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border);cursor:crosshair" onclick="pickBgColor(event)"></canvas>
        <div style="margin-top:16px"><button class="btn btn-primary" onclick="downloadCanvas('bgCanvas','no_background.png')">‚¨á Download PNG (transparent)</button></div>
      </div>`;

    // ====== SCREENSHOT BEAUTIFIER ======
    case 'screenshot-beautify': return `${close}<h2>üì∏ Screenshot Beautifier</h2><p class="subtitle">Add beautiful backgrounds, shadows and rounded corners to screenshots</p>
      ${upload('ssInput','image/*')}
      <div id="ssLoaded" style="display:none">
        <div class="form-group"><label>Background</label><select class="form-select" id="ssBg" onchange="renderSS()">
          <option value="linear-gradient(135deg,#667eea,#764ba2)">Purple Gradient</option>
          <option value="linear-gradient(135deg,#f093fb,#f5576c)">Pink Gradient</option>
          <option value="linear-gradient(135deg,#4facfe,#00f2fe)">Blue Gradient</option>
          <option value="linear-gradient(135deg,#43e97b,#38f9d7)">Green Gradient</option>
          <option value="linear-gradient(135deg,#fa709a,#fee140)">Sunset Gradient</option>
          <option value="linear-gradient(135deg,#a18cd1,#fbc2eb)">Lavender</option>
          <option value="linear-gradient(135deg,#2d3436,#636e72)">Dark</option>
          <option value="#ffffff">White</option>
          <option value="#000000">Black</option>
        </select></div>
        <div class="form-group"><label>Padding: <strong id="ssPadV">60</strong>px</label><div class="slider-group"><input type="range" min="20" max="150" value="60" id="ssPad" oninput="document.getElementById('ssPadV').textContent=this.value;renderSS()"></div></div>
        <div class="form-group"><label>Corner Radius: <strong id="ssRadV">12</strong>px</label><div class="slider-group"><input type="range" min="0" max="40" value="12" id="ssRad" oninput="document.getElementById('ssRadV').textContent=this.value;renderSS()"></div></div>
        <div class="form-group"><label>Shadow Strength: <strong id="ssShadV">30</strong></label><div class="slider-group"><input type="range" min="0" max="60" value="30" id="ssShad" oninput="document.getElementById('ssShadV').textContent=this.value;renderSS()"></div></div>
        <canvas id="ssCanvas" style="max-width:100%;border-radius:var(--radius-sm);border:1px solid var(--border)"></canvas>
        <div style="margin-top:16px"><button class="btn btn-primary" onclick="downloadCanvas('ssCanvas','beautiful_screenshot.png')">‚¨á Download</button></div>
      </div>`;

    // ====== PDF TOOLS ======
    case 'pdf-tools': return `${close}<h2>üìÑ PDF Tools</h2><p class="subtitle">Merge, split, and convert PDFs in your browser</p>
      <div class="tabs"><button class="tab-btn active" onclick="pdfTab(this,'pdfMerge')">Merge PDFs</button><button class="tab-btn" onclick="pdfTab(this,'pdfImgToPdf')">Images ‚Üí PDF</button><button class="tab-btn" onclick="pdfTab(this,'pdfInfo')">PDF Info</button></div>
      <div id="pdfMerge"><p style="font-size:13px;color:var(--text2);margin-bottom:12px">Select multiple PDF files to merge into one:</p>
        <input type="file" id="pdfMergeInput" accept=".pdf" multiple class="form-input" style="padding:12px">
        <button class="btn btn-primary" style="margin-top:12px" onclick="mergePdfs()">üìÑ Merge PDFs</button>
        <div class="result-area" id="pdfMergeResult"></div></div>
      <div id="pdfImgToPdf" style="display:none"><p style="font-size:13px;color:var(--text2);margin-bottom:12px">Select images to combine into a PDF:</p>
        <input type="file" id="pdfImgInput" accept="image/*" multiple class="form-input" style="padding:12px">
        <button class="btn btn-primary" style="margin-top:12px" onclick="imgsToPdf()">üìÑ Create PDF</button>
        <div class="result-area" id="pdfImgResult"></div></div>
      <div id="pdfInfo" style="display:none"><p style="font-size:13px;color:var(--text2);margin-bottom:12px">Upload a PDF to see its metadata:</p>
        <input type="file" id="pdfInfoInput" accept=".pdf" class="form-input" style="padding:12px">
        <div class="result-area" id="pdfInfoResult"></div></div>`;

    // ====== DATE & TIME TOOLS ======
    case 'date-tools': return `${close}<h2>‚è±Ô∏è Date & Time Tools</h2><p class="subtitle">Unix timestamp, age calculator, date difference & more</p>
      <div class="tabs"><button class="tab-btn active" onclick="pdfTab(this,'dtTimestamp')">Timestamp</button><button class="tab-btn" onclick="pdfTab(this,'dtAge')">Age Calculator</button><button class="tab-btn" onclick="pdfTab(this,'dtDiff')">Date Diff</button><button class="tab-btn" onclick="pdfTab(this,'dtCountdown')">Countdown</button></div>
      <div id="dtTimestamp">
        <div class="form-group"><label>Current Unix Timestamp</label><div class="password-display" onclick="copyText(this.textContent)" id="dtNow" style="font-size:28px;cursor:pointer"></div></div>
        <div class="form-group"><label>Timestamp ‚Üí Date</label><div style="display:flex;gap:8px"><input class="form-input" id="dtTs2Date" placeholder="e.g. 1700000000"><button class="btn btn-secondary" onclick="ts2date()">Convert</button></div><p id="dtTs2DateResult" style="padding:8px 0;color:var(--green);font-size:14px"></p></div>
        <div class="form-group"><label>Date ‚Üí Timestamp</label><div style="display:flex;gap:8px"><input class="form-input" type="datetime-local" id="dtDate2Ts"><button class="btn btn-secondary" onclick="date2ts()">Convert</button></div><p id="dtDate2TsResult" style="padding:8px 0;color:var(--green);font-size:14px"></p></div>
      </div>
      <div id="dtAge" style="display:none">
        <div class="form-group"><label>Date of Birth</label><input class="form-input" type="date" id="dtBirth"></div>
        <button class="btn btn-primary" onclick="calcAge()">üéÇ Calculate Age</button>
        <p id="dtAgeResult" style="padding:12px 0;font-size:16px"></p>
      </div>
      <div id="dtDiff" style="display:none">
        <div style="display:flex;gap:12px;flex-wrap:wrap"><div class="form-group" style="flex:1;min-width:140px"><label>Start Date</label><input class="form-input" type="date" id="dtStart"></div><div class="form-group" style="flex:1;min-width:140px"><label>End Date</label><input class="form-input" type="date" id="dtEnd"></div></div>
        <button class="btn btn-primary" onclick="calcDateDiff()">üìÖ Calculate Difference</button>
        <p id="dtDiffResult" style="padding:12px 0;font-size:16px"></p>
      </div>
      <div id="dtCountdown" style="display:none">
        <div class="form-group"><label>Target Date & Time</label><input class="form-input" type="datetime-local" id="dtTarget"></div>
        <button class="btn btn-primary" onclick="startCountdown()">‚è≥ Start Countdown</button>
        <div class="password-display" id="dtCountdownDisplay" style="font-size:22px;display:none"></div>
      </div>`;

    // ====== CURRENCY CONVERTER ======
    case 'currency': return `${close}<h2>üí± Currency Converter</h2><p class="subtitle">Convert between 150+ currencies with live rates</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
        <div class="form-group" style="flex:1;min-width:100px"><label>Amount</label><input class="form-input" type="number" id="curAmt" value="1" oninput="convertCurrency()"></div>
        <div class="form-group" style="flex:1;min-width:100px"><label>From</label><select class="form-select" id="curFrom" onchange="convertCurrency()"></select></div>
        <div style="display:flex;align-items:end;padding-bottom:8px"><button class="btn btn-secondary" style="padding:8px 12px" onclick="swapCurrency()">‚áÑ</button></div>
        <div class="form-group" style="flex:1;min-width:100px"><label>To</label><select class="form-select" id="curTo" onchange="convertCurrency()"></select></div>
      </div>
      <div class="password-display" id="curResult" style="font-size:24px">‚Äî</div>
      <p style="font-size:11px;color:var(--text2);margin-top:8px" id="curRate">Rates provided by exchangerate-api.com</p>`;

    // ====== IP LOOKUP ======
    case 'ip-lookup': return `${close}<h2>üîç What Is My IP</h2><p class="subtitle">Find your public IP address and connection details</p>
      <div class="password-display" id="ipDisplay" style="font-size:28px;cursor:pointer" onclick="copyText(this.textContent)">Loading...</div>
      <div id="ipDetails" style="display:flex;flex-wrap:wrap;gap:12px;margin-top:16px"></div>
      <div class="form-group" style="margin-top:24px"><label>Lookup any IP address</label><div style="display:flex;gap:8px"><input class="form-input" id="ipLookupInput" placeholder="e.g. 8.8.8.8"><button class="btn btn-primary" onclick="lookupIp()">üîç Lookup</button></div></div>
      <div class="result-area" id="ipLookupResult"></div>`;

    // ====== TEXT DIFF ======
    case 'text-diff': return `${close}<h2>üìù Text Compare / Diff</h2><p class="subtitle">Compare two texts and highlight differences</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <div class="form-group" style="flex:1;min-width:200px"><label>Original Text</label><textarea class="form-input" id="diffA" rows="10" placeholder="Paste original text here..." oninput="runDiff()"></textarea></div>
        <div class="form-group" style="flex:1;min-width:200px"><label>Modified Text</label><textarea class="form-input" id="diffB" rows="10" placeholder="Paste modified text here..." oninput="runDiff()"></textarea></div>
      </div>
      <div id="diffStats" style="padding:8px 0;font-size:13px;color:var(--text2)"></div>
      <div id="diffOutput" style="background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px;font-family:monospace;font-size:13px;line-height:1.8;white-space:pre-wrap;max-height:400px;overflow-y:auto"></div>`;

    // ====== CSS GRADIENT GENERATOR ======
    case 'gradient-gen': return `${close}<h2>üé® CSS Gradient Generator</h2><p class="subtitle">Create beautiful CSS gradients with live preview</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
        <div class="form-group"><label>Type</label><select class="form-select" id="gradType" onchange="updateGrad()"><option value="linear">Linear</option><option value="radial">Radial</option><option value="conic">Conic</option></select></div>
        <div class="form-group"><label>Angle: <strong id="gradAngV">135</strong>¬∞</label><div class="slider-group"><input type="range" min="0" max="360" value="135" id="gradAng" oninput="updateGrad()"></div></div>
      </div>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:16px">
        <div class="form-group"><label>Color 1</label><input type="color" id="gradC1" value="#6c5ce7" onchange="updateGrad()" style="width:60px;height:40px;border:none;cursor:pointer"></div>
        <div class="form-group"><label>Color 2</label><input type="color" id="gradC2" value="#fd79a8" onchange="updateGrad()" style="width:60px;height:40px;border:none;cursor:pointer"></div>
        <div class="form-group"><label>Color 3 (optional)</label><input type="color" id="gradC3" value="#00b894" onchange="updateGrad()" style="width:60px;height:40px;border:none;cursor:pointer"></div>
        <div class="check-group" style="align-items:end;padding-bottom:8px"><label><input type="checkbox" id="gradUse3" onchange="updateGrad()"> Use 3rd color</label></div>
      </div>
      <div id="gradPreview" style="height:200px;border-radius:var(--radius-sm);border:1px solid var(--border);margin-bottom:16px"></div>
      <div class="form-group"><label>CSS Code</label><div style="position:relative"><textarea class="form-input" id="gradCSS" rows="3" readonly style="font-family:monospace;font-size:13px"></textarea><button class="btn btn-secondary" style="position:absolute;top:8px;right:8px;padding:4px 12px;font-size:11px" onclick="copyText(document.getElementById('gradCSS').value)">Copy</button></div></div>`;

    // ====== POMODORO TIMER ======
    case 'pomodoro': return `${close}<h2>‚è≤Ô∏è Pomodoro Timer</h2><p class="subtitle">Stay focused ‚Äî 25 min work, 5 min break</p>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:20px">
        <div class="form-group" style="flex:1;min-width:80px"><label>Work (min)</label><input class="form-input" type="number" id="pomWork" value="25" min="1" max="120"></div>
        <div class="form-group" style="flex:1;min-width:80px"><label>Short Break</label><input class="form-input" type="number" id="pomBreak" value="5" min="1" max="30"></div>
        <div class="form-group" style="flex:1;min-width:80px"><label>Long Break</label><input class="form-input" type="number" id="pomLong" value="15" min="1" max="60"></div>
      </div>
      <div style="text-align:center;margin-bottom:20px">
        <div id="pomPhase" style="font-size:14px;color:var(--accent2);margin-bottom:8px">WORK</div>
        <div class="password-display" id="pomDisplay" style="font-size:56px;letter-spacing:6px">25:00</div>
        <div style="margin-top:4px;font-size:13px;color:var(--text2)">Session <span id="pomSession">1</span>/4</div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center">
        <button class="btn btn-primary" id="pomStartBtn" onclick="pomToggle()">‚ñ∂ Start</button>
        <button class="btn btn-secondary" onclick="pomReset()">‚Ü© Reset</button>
        <button class="btn btn-secondary" onclick="pomSkip()">‚è≠ Skip</button>
      </div>`;

    // ====== URL TOOLS ======
    case 'url-tools': return `${close}<h2>üîó URL Tools</h2><p class="subtitle">Encode, decode, parse URLs and generate QR codes</p>
      <div class="tabs"><button class="tab-btn active" onclick="pdfTab(this,'urlEncode')">Encode/Decode</button><button class="tab-btn" onclick="pdfTab(this,'urlParse')">Parse URL</button><button class="tab-btn" onclick="pdfTab(this,'urlQr')">URL ‚Üí QR</button></div>
      <div id="urlEncode">
        <div class="form-group"><label>Input URL or Text</label><textarea class="form-input" id="urlEncInput" rows="3" placeholder="https://example.com/path?q=hello world" oninput="urlEncDec()"></textarea></div>
        <div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-secondary" onclick="urlDoEnc()">Encode</button><button class="btn btn-secondary" onclick="urlDoDec()">Decode</button></div>
        <div class="form-group"><label>Result</label><textarea class="form-input" id="urlEncOutput" rows="3" readonly></textarea></div>
      </div>
      <div id="urlParse" style="display:none">
        <div class="form-group"><label>Enter URL</label><input class="form-input" id="urlParseInput" placeholder="https://example.com/path?key=val&foo=bar#section" oninput="parseUrl()"></div>
        <div id="urlParseResult" style="font-size:13px"></div>
      </div>
      <div id="urlQr" style="display:none">
        <div class="form-group"><label>URL for QR Code</label><input class="form-input" id="urlQrInput" placeholder="https://example.com"></div>
        <button class="btn btn-primary" onclick="urlToQr()">üì± Generate QR</button>
        <div style="text-align:center;margin-top:16px"><canvas id="urlQrCanvas"></canvas></div>
      </div>`;

    // ====== LEGAL PAGES ======
    case 'privacy': return `${close}<h2>üîí Privacy Policy</h2><p class="subtitle">Last updated: February 2025</p>
      <div style="font-size:14px;line-height:1.8;color:var(--text2)">
        <p><strong style="color:var(--text)">Summary:</strong> UtilHub processes everything locally in your browser. We do not collect, store, or transmit your files or personal data.</p><br>
        <p><strong style="color:var(--text)">1. Data Processing</strong><br>All tools (image editing, PDF processing, audio editing, text tools, etc.) run entirely in your web browser using JavaScript. Your files never leave your device. No data is uploaded to our servers.</p><br>
        <p><strong style="color:var(--text)">2. External APIs</strong><br>Some tools may connect to third-party APIs for functionality: Currency Converter uses exchange rate APIs, IP Lookup uses ipapi.co, and QR code generation uses a local library. These connections are made directly from your browser.</p><br>
        <p><strong style="color:var(--text)">3. Analytics & Advertising</strong><br>We may use Google Analytics to understand how visitors use the site (page views, country, device type). We may display ads through Google AdSense. These services may use cookies. You can disable cookies in your browser settings.</p><br>
        <p><strong style="color:var(--text)">4. Cookies</strong><br>We use minimal cookies for analytics and advertising purposes only. No cookies are used to track your personal data or file contents.</p><br>
        <p><strong style="color:var(--text)">5. Third-Party Links</strong><br>Our site contains links to external services (LALAL.ai, remove.bg, etc.). We are not responsible for their privacy practices.</p><br>
        <p><strong style="color:var(--text)">6. Contact</strong><br>For privacy-related questions, please contact us through our social media channels.</p>
      </div>`;

    case 'terms': return `${close}<h2>üìã Terms of Use</h2><p class="subtitle">Last updated: February 2025</p>
      <div style="font-size:14px;line-height:1.8;color:var(--text2)">
        <p><strong style="color:var(--text)">1. Acceptance</strong><br>By using UtilHub, you agree to these terms. If you disagree, please discontinue use.</p><br>
        <p><strong style="color:var(--text)">2. Service Description</strong><br>UtilHub provides free browser-based tools for image editing, PDF processing, audio editing, text manipulation, calculations, and development utilities. All processing occurs locally in your browser.</p><br>
        <p><strong style="color:var(--text)">3. No Warranty</strong><br>Tools are provided "as is" without warranty. Results may vary depending on your browser, device, and input files. We are not liable for any data loss or inaccurate results.</p><br>
        <p><strong style="color:var(--text)">4. Intellectual Property</strong><br>You retain all rights to your files. We do not claim ownership of any content you process using our tools. The UtilHub brand, design, and code are our intellectual property.</p><br>
        <p><strong style="color:var(--text)">5. Acceptable Use</strong><br>You agree not to use UtilHub for any illegal purpose or to process content that violates applicable laws.</p><br>
        <p><strong style="color:var(--text)">6. Limitation of Liability</strong><br>UtilHub is not responsible for any direct, indirect, or consequential damages arising from the use of our tools.</p><br>
        <p><strong style="color:var(--text)">7. Changes</strong><br>We may update these terms at any time. Continued use constitutes acceptance of updated terms.</p>
      </div>`;

    case 'about': return `${close}<h2>üß∞ About UtilHub</h2><p class="subtitle">Free tools for everyone</p>
      <div style="font-size:14px;line-height:1.8;color:var(--text2)">
        <p>UtilHub is a collection of <strong style="color:var(--text)">37+ free online tools</strong> that run entirely in your browser. No signup, no upload limits, no hidden fees.</p><br>
        <p><strong style="color:var(--text)">Why UtilHub?</strong><br>We believe essential digital tools should be free and private. Every tool on UtilHub processes your data locally ‚Äî your files never leave your device.</p><br>
        <p><strong style="color:var(--text)">Categories:</strong><br>üñºÔ∏è Image Tools ‚Äî Compress, resize, convert, crop, filters, effects, remove background, collage, screenshot beautifier<br>üìÑ Text & PDF ‚Äî Word counter, Markdown preview, text diff, JSON formatter, PDF merge<br>üéµ Audio ‚Äî Speed changer, vocal separator, effects<br>üíª Dev ‚Äî QR generator, color picker, regex tester, CSS gradients, URL tools<br>üßÆ Math ‚Äî Unit converter, calculator, currency converter, date tools<br>üîí Security ‚Äî Password generator, Base64, hash generator</p><br>
        <p><strong style="color:var(--text)">Built with ‚ù§Ô∏è</strong><br>UtilHub is built with vanilla HTML, CSS, and JavaScript. No frameworks, no dependencies (except a few CDN libraries for QR codes and marked.js).</p>
      </div>`;

    default: return `${close}<h2>Coming Soon</h2><p class="subtitle">This tool is being developed.</p>`;
  }
}

// =====================================================
// TOOL LOGIC ‚Äî IMAGE
// =====================================================
let compressedBlob=null;
document.addEventListener('change',function(e){
  if(e.target.id==='fileInput') compressImage(e.target.files[0]);
  if(e.target.id==='resizeInput') loadResize(e.target.files[0]);
  if(e.target.id==='convInput') loadConvert(e.target.files[0]);
  if(e.target.id==='audioSpeedInput') loadAudioSpeed(e.target.files[0]);
  if(e.target.id==='stemInput') loadStemAudio(e.target.files[0]);
  if(e.target.id==='fxInput') loadFxAudio(e.target.files[0]);
  if(e.target.id==='pfInput') loadPhotoFilter(e.target.files[0]);
  if(e.target.id==='adjInput') loadAdjust(e.target.files[0]);
  if(e.target.id==='cropInput') loadCrop(e.target.files[0]);
  if(e.target.id==='textImgInput') loadTextImg(e.target.files[0]);
  if(e.target.id==='collageInput') loadCollage(e.target.files);
  if(e.target.id==='cfxInput') loadCfx(e.target.files[0]);
  if(e.target.id==='bgInput') loadBg(e.target.files[0]);
  if(e.target.id==='ssInput') loadSS(e.target.files[0]);
});
function compressImage(file){if(!file)return;const q=document.getElementById('qualitySlider').value/100;const r=new FileReader();r.onload=function(e){const img=new Image();img.onload=function(){const c=document.getElementById('compressCanvas');c.width=img.width;c.height=img.height;c.getContext('2d').drawImage(img,0,0);c.toBlob(function(blob){compressedBlob=blob;document.getElementById('origSize').textContent=formatBytes(file.size);document.getElementById('compSize').textContent=formatBytes(blob.size);document.getElementById('reduction').textContent=((1-blob.size/file.size)*100).toFixed(1)+'%';document.getElementById('compressResult').classList.add('active')},'image/jpeg',q)};img.src=e.target.result};r.readAsDataURL(file)}
function downloadCompressed(){if(compressedBlob){const a=document.createElement('a');a.href=URL.createObjectURL(compressedBlob);a.download='compressed.jpg';a.click()}}
let resizeImg=null;
function loadResize(f){if(!f)return;const r=new FileReader();r.onload=function(e){resizeImg=new Image();resizeImg.onload=function(){document.getElementById('resW').value=resizeImg.width;document.getElementById('resH').value=resizeImg.height;document.getElementById('resizeBtn').disabled=false};resizeImg.src=e.target.result};r.readAsDataURL(f)}
function lockRatio(){if(!resizeImg||!document.getElementById('keepRatio').checked)return;document.getElementById('resH').value=Math.round(document.getElementById('resW').value*(resizeImg.height/resizeImg.width))}
function lockRatioH(){if(!resizeImg||!document.getElementById('keepRatio').checked)return;document.getElementById('resW').value=Math.round(document.getElementById('resH').value*(resizeImg.width/resizeImg.height))}
function doResize(){if(!resizeImg)return;const c=document.getElementById('resizeCanvas');c.width=parseInt(document.getElementById('resW').value);c.height=parseInt(document.getElementById('resH').value);c.getContext('2d').drawImage(resizeImg,0,0,c.width,c.height);document.getElementById('resizeResult').classList.add('active')}
function downloadResized(){const c=document.getElementById('resizeCanvas');const a=document.createElement('a');a.href=c.toDataURL('image/png');a.download='resized.png';a.click()}
let convImg=null;
function loadConvert(f){if(!f)return;const r=new FileReader();r.onload=function(e){convImg=new Image();convImg.onload=()=>document.getElementById('convBtn').disabled=false;convImg.src=e.target.result};r.readAsDataURL(f)}
function doConvert(){if(!convImg)return;const c=document.getElementById('convCanvas');c.width=convImg.width;c.height=convImg.height;c.getContext('2d').drawImage(convImg,0,0);document.getElementById('convMsg').textContent='‚úì Converted to '+document.getElementById('convFormat').value.split('/')[1].toUpperCase()+'!';document.getElementById('convResult').classList.add('active')}
function downloadConverted(){const c=document.getElementById('convCanvas');const f=document.getElementById('convFormat').value;const a=document.createElement('a');a.href=c.toDataURL(f);a.download='converted.'+f.split('/')[1];a.click()}

// =====================================================
// QR CODE
// =====================================================
let qrInstance=null;
function initQR(){updateQR()}
function updateQR(){const el=document.getElementById('qrPreview');if(!el)return;el.innerHTML='';qrInstance=new QRCode(el,{text:document.getElementById('qrText').value||'https://utilhub.com',width:parseInt(document.getElementById('qrSize').value),height:parseInt(document.getElementById('qrSize').value),colorDark:document.getElementById('qrColor').value,colorLight:'#ffffff',correctLevel:QRCode.CorrectLevel.H})}
function downloadQR(){const c=document.querySelector('#qrPreview canvas');if(c){const a=document.createElement('a');a.href=c.toDataURL();a.download='qrcode.png';a.click()}}

// =====================================================
// COLOR PICKER
// =====================================================
function updateColor(){renderColor(document.getElementById('colorPick').value)}
function updateFromHex(){const h=document.getElementById('hexInput').value;if(/^#[0-9a-fA-F]{6}$/.test(h)){document.getElementById('colorPick').value=h;renderColor(h)}}
function renderColor(hex){document.getElementById('colorPreview').style.background=hex;const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);const hsl=rgbToHsl(r,g,b);document.getElementById('colorValues').innerHTML=`<div class="stat-box" onclick="copyText('${hex}')" style="cursor:pointer"><div class="label">HEX</div><div class="value">${hex}</div></div><div class="stat-box" onclick="copyText('rgb(${r},${g},${b})')" style="cursor:pointer"><div class="label">RGB</div><div class="value">${r}, ${g}, ${b}</div></div><div class="stat-box" onclick="copyText('hsl(${hsl[0]},${hsl[1]}%,${hsl[2]}%)')" style="cursor:pointer"><div class="label">HSL</div><div class="value">${hsl[0]}¬∞, ${hsl[1]}%, ${hsl[2]}%</div></div>`;document.getElementById('harmonicPalette').innerHTML=[0,30,60,120,180,210,270,330].map(a=>{const c=`hsl(${(hsl[0]+a)%360},${hsl[1]}%,${hsl[2]}%)`;return`<div style="width:48px;height:48px;border-radius:10px;background:${c};cursor:pointer;border:2px solid var(--border)" onclick="copyText('${c}')"></div>`}).join('')}
function rgbToHsl(r,g,b){r/=255;g/=255;b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b),l=(max+min)/2;let h=0,s=0;if(max!==min){const d=max-min;s=l>.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break}}return[Math.round(h*360),Math.round(s*100),Math.round(l*100)]}

// =====================================================
// PASSWORD, WORD COUNTER, CASE, LOREM, JSON, BASE64, MD
// =====================================================
function generatePassword(){const len=parseInt(document.getElementById('pwdLen').value);let chars='';if(document.getElementById('pwdUpper').checked)chars+='ABCDEFGHIJKLMNOPQRSTUVWXYZ';if(document.getElementById('pwdLower').checked)chars+='abcdefghijklmnopqrstuvwxyz';if(document.getElementById('pwdNumbers').checked)chars+='0123456789';if(document.getElementById('pwdSymbols').checked)chars+='!@#$%^&*()_+-=[]{}|;:,.<>?';if(!chars)chars='abcdefghijklmnopqrstuvwxyz';let p='';const a=new Uint32Array(len);crypto.getRandomValues(a);for(let i=0;i<len;i++)p+=chars[a[i]%chars.length];document.getElementById('pwdDisplay').textContent=p;let sc=0;if(len>=8)sc++;if(len>=12)sc++;if(len>=20)sc++;if(document.getElementById('pwdUpper').checked&&document.getElementById('pwdLower').checked)sc++;if(document.getElementById('pwdNumbers').checked)sc++;if(document.getElementById('pwdSymbols').checked)sc++;const pct=Math.min(sc/6*100,100);const f=document.getElementById('strengthFill');f.style.width=pct+'%';f.style.background=pct<40?'var(--red)':pct<70?'var(--orange)':'var(--green)';document.getElementById('strengthText').textContent=pct<40?'Weak':pct<70?'Good':'Very Strong'}
function countWords(){const t=document.getElementById('wcText').value;document.getElementById('wcChars').textContent=t.length;document.getElementById('wcWords').textContent=t.trim()?t.trim().split(/\s+/).length:0;document.getElementById('wcSentences').textContent=t.trim()?t.split(/[.!?]+/).filter(s=>s.trim()).length:0;document.getElementById('wcParas').textContent=t.trim()?t.split(/\n\n+/).filter(p=>p.trim()).length:0;const w=t.trim()?t.trim().split(/\s+/).length:0;document.getElementById('wcRead').textContent=Math.ceil(w/200)+' min';document.getElementById('wcSpeak').textContent=Math.ceil(w/130)+' min'}
function convertCase(type){const t=document.getElementById('caseText').value;let r='';switch(type){case'upper':r=t.toUpperCase();break;case'lower':r=t.toLowerCase();break;case'title':r=t.replace(/\w\S*/g,w=>w.charAt(0).toUpperCase()+w.substr(1).toLowerCase());break;case'sentence':r=t.toLowerCase().replace(/(^\s*|[.!?]\s+)(\w)/g,(m,a,b)=>a+b.toUpperCase());break;case'toggle':r=[...t].map(c=>c===c.toUpperCase()?c.toLowerCase():c.toUpperCase()).join('');break;case'slug':r=t.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^a-z0-9]+/g,'-').replace(/^-|-$/g,'');break}document.getElementById('caseResult').value=r}
function genLorem(){const L="Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Curabitur pretium tincidunt lacus. Nulla gravida orci a odio.".split('. ').map(s=>s.endsWith('.')?s:s+'.');const c=parseInt(document.getElementById('loremCount').value)||3;const tp=document.getElementById('loremType').value;let r='';if(tp==='words')r=L.join(' ').split(' ').slice(0,c).join(' ');else if(tp==='sentences'){const a=[];for(let i=0;i<c;i++)a.push(L[i%L.length]);r=a.join(' ')}else{const p=[];for(let i=0;i<c;i++)p.push(L.slice((i*3)%L.length,(i*3)%L.length+4).join(' '));r=p.join('\n\n')}document.getElementById('loremResult').value=r}
function formatJSON(){try{document.getElementById('jsonOutput').textContent=JSON.stringify(JSON.parse(document.getElementById('jsonInput').value),null,2);document.getElementById('jsonOutput').style.color='var(--accent2)'}catch(e){document.getElementById('jsonOutput').textContent='‚ùå Invalid JSON: '+e.message;document.getElementById('jsonOutput').style.color='var(--red)'}}
function minifyJSON(){try{document.getElementById('jsonOutput').textContent=JSON.stringify(JSON.parse(document.getElementById('jsonInput').value));document.getElementById('jsonOutput').style.color='var(--green)'}catch(e){document.getElementById('jsonOutput').textContent='‚ùå Invalid JSON: '+e.message;document.getElementById('jsonOutput').style.color='var(--red)'}}
let b64Mode='encode';
function doBase64(){const i=document.getElementById('b64Input').value;try{document.getElementById('b64Output').value=b64Mode==='encode'?btoa(unescape(encodeURIComponent(i))):decodeURIComponent(escape(atob(i)))}catch(e){document.getElementById('b64Output').value='‚ùå Error: '+e.message}}
function updateMD(){document.getElementById('mdPreview').innerHTML=marked.parse(document.getElementById('mdInput').value||'')}

// =====================================================
// CALCULATORS
// =====================================================
function calcBMI(){const w=parseFloat(document.getElementById('bmiW').value),h=parseFloat(document.getElementById('bmiH').value)/100;if(!w||!h)return;const bmi=w/(h*h);let cat='',col='';if(bmi<18.5){cat='Underweight';col='var(--orange)'}else if(bmi<25){cat='Normal weight';col='var(--green)'}else if(bmi<30){cat='Overweight';col='var(--orange)'}else{cat='Obese';col='var(--red)'}const el=document.getElementById('bmiResult');el.classList.add('active');el.innerHTML=`<div style="text-align:center"><span style="font-size:48px;font-weight:700;color:${col}">${bmi.toFixed(1)}</span><p style="color:${col};font-size:18px;margin-top:8px">${cat}</p></div><p style="font-size:12px;color:var(--text2);margin-top:16px;text-align:center">This is informational only. Consult a healthcare professional for personalized guidance.</p>`}
function calcInterest(){const cap=parseFloat(document.getElementById('jCap').value)||0,add=parseFloat(document.getElementById('jAdd').value)||0,rate=parseFloat(document.getElementById('jRate').value)/100,months=parseInt(document.getElementById('jMonths').value)||0;let total=cap,invested=cap;for(let i=0;i<months;i++){total=total*(1+rate)+add;invested+=add}const interest=total-invested;const el=document.getElementById('interestResult');el.classList.add('active');el.innerHTML=`<div class="stats-row"><div class="stat-box"><div class="label">Total Invested</div><div class="value">$${invested.toLocaleString('en',{minimumFractionDigits:2})}</div></div><div class="stat-box"><div class="label">Interest Earned</div><div class="value green">$${interest.toLocaleString('en',{minimumFractionDigits:2})}</div></div><div class="stat-box"><div class="label">Final Amount</div><div class="value orange">$${total.toLocaleString('en',{minimumFractionDigits:2})}</div></div></div>`}
function calcPercent(){const a=parseFloat(document.getElementById('percA').value),b=parseFloat(document.getElementById('percB').value);if(isNaN(a)||isNaN(b))return;const el=document.getElementById('percResult');el.classList.add('active');el.innerHTML=`<span style="font-size:28px;font-weight:700">${((a/100)*b).toLocaleString('en',{maximumFractionDigits:4})}</span>`}
function calcVariation(){const f=parseFloat(document.getElementById('percFrom').value),t=parseFloat(document.getElementById('percTo').value);if(isNaN(f)||isNaN(t)||f===0)return;const v=((t-f)/f*100);const el=document.getElementById('varResult');el.classList.add('active');el.innerHTML=`<span style="font-size:28px;font-weight:700;color:${v>=0?'var(--green)':'var(--red)'}">${v>=0?'+':''}${v.toFixed(2)}%</span>`}

// =====================================================
// HASH, UNITS, REGEX
// =====================================================
async function genHash(){const t=document.getElementById('hashInput').value;if(!t){document.getElementById('hashSHA256').textContent='-';document.getElementById('hashSHA1').textContent='-';return}const enc=new TextEncoder().encode(t);const[s256,s1]=await Promise.all([crypto.subtle.digest('SHA-256',enc),crypto.subtle.digest('SHA-1',enc)]);document.getElementById('hashSHA256').textContent=Array.from(new Uint8Array(s256)).map(b=>b.toString(16).padStart(2,'0')).join('');document.getElementById('hashSHA1').textContent=Array.from(new Uint8Array(s1)).map(b=>b.toString(16).padStart(2,'0')).join('')}
const units={length:{m:1,km:1000,cm:.01,mm:.001,mi:1609.34,ft:.3048,in_:.0254,yd:.9144},weight:{kg:1,g:.001,mg:1e-6,lb:.453592,oz:.0283495,t:1000},temperature:'special',volume:{L:1,mL:.001,gal:3.78541,qt:.946353,cup:.236588,fl_oz:.0295735},data:{B:1,KB:1024,MB:1048576,GB:1073741824,TB:1099511627776}};
const unitLabels={length:{m:'Meter',km:'Kilometer',cm:'Centimeter',mm:'Millimeter',mi:'Mile',ft:'Foot',in_:'Inch',yd:'Yard'},weight:{kg:'Kilogram',g:'Gram',mg:'Milligram',lb:'Pound',oz:'Ounce',t:'Ton'},temperature:{C:'Celsius',F:'Fahrenheit',K:'Kelvin'},volume:{L:'Liter',mL:'Milliliter',gal:'Gallon',qt:'Quart',cup:'Cup',fl_oz:'Fl Oz'},data:{B:'Bytes',KB:'Kilobytes',MB:'Megabytes',GB:'Gigabytes',TB:'Terabytes'}};
function updateUnits(){const c=document.getElementById('unitCat').value;const l=unitLabels[c];const o=Object.entries(l).map(([k,v])=>`<option value="${k}">${v}</option>`).join('');document.getElementById('unitFrom').innerHTML=o;document.getElementById('unitTo').innerHTML=o;if(Object.keys(l).length>1)document.getElementById('unitTo').selectedIndex=1;convertUnit()}
function convertUnit(){const c=document.getElementById('unitCat').value,v=parseFloat(document.getElementById('unitVal').value),f=document.getElementById('unitFrom').value,t=document.getElementById('unitTo').value;if(isNaN(v)){document.getElementById('unitOutput').textContent='-';return}let r;if(c==='temperature'){let cel;if(f==='C')cel=v;else if(f==='F')cel=(v-32)*5/9;else cel=v-273.15;if(t==='C')r=cel;else if(t==='F')r=cel*9/5+32;else r=cel+273.15}else{const u=units[c];r=v*u[f]/u[t]}document.getElementById('unitOutput').textContent=r.toLocaleString('en',{maximumFractionDigits:8})}
function testRegex(){const expr=document.getElementById('regexExpr').value,flags=document.getElementById('regexFlags').value,text=document.getElementById('regexText').value,md=document.getElementById('regexMatches'),cp=document.getElementById('regexCount');if(!expr||!text){md.innerHTML='<span style="color:var(--text2)">No matches</span>';cp.textContent='0 matches';return}try{const re=new RegExp(expr,flags);const m=[...text.matchAll(re)];if(!m.length){md.innerHTML='<span style="color:var(--text2)">No matches</span>';cp.textContent='0 matches';return}md.innerHTML=m.map(x=>`<span style="background:var(--accent);color:#fff;padding:2px 8px;border-radius:4px;margin:2px;display:inline-block">${x[0]}</span>`).join(' ');cp.textContent=m.length+' match'+(m.length>1?'es':'')}catch(e){md.innerHTML=`<span style="color:var(--red)">Invalid regex: ${e.message}</span>`;cp.textContent=''}}

// =====================================================
// TAB HELPER (reused by PDF, Date, URL tools)
// =====================================================
function pdfTab(btn, showId) {
  const parent = btn.closest('.modal');
  const tabs = btn.parentElement.querySelectorAll('.tab-btn');
  tabs.forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  // Hide siblings, show target
  const container = btn.parentElement.nextElementSibling;
  let sib = btn.parentElement.nextElementSibling;
  while (sib) {
    if (sib.id) sib.style.display = sib.id === showId ? 'block' : 'none';
    sib = sib.nextElementSibling;
  }
}

// =====================================================
// 1. PDF TOOLS
// =====================================================
async function mergePdfs() {
  const files = document.getElementById('pdfMergeInput').files;
  if (!files || files.length < 2) { showToast('Select at least 2 PDFs'); return; }
  showToast('PDF merge requires pdf-lib. Loading...');
  // Load pdf-lib dynamically
  if (!window.PDFLib) {
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js';
    document.head.appendChild(s);
    await new Promise(r => s.onload = r);
  }
  try {
    const merged = await PDFLib.PDFDocument.create();
    for (const file of files) {
      const ab = await file.arrayBuffer();
      const pdf = await PDFLib.PDFDocument.load(ab);
      const pages = await merged.copyPages(pdf, pdf.getPageIndices());
      pages.forEach(p => merged.addPage(p));
    }
    const bytes = await merged.save();
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    document.getElementById('pdfMergeResult').innerHTML = `<p style="color:var(--green)">‚úì Merged ${files.length} PDFs (${(blob.size/1024).toFixed(0)} KB)</p><a href="${url}" download="merged.pdf" class="btn btn-primary">‚¨á Download Merged PDF</a>`;
    document.getElementById('pdfMergeResult').classList.add('active');
  } catch(e) { showToast('Error: ' + e.message); }
}
async function imgsToPdf() {
  const files = document.getElementById('pdfImgInput').files;
  if (!files || !files.length) { showToast('Select at least 1 image'); return; }
  if (!window.PDFLib) {
    const s = document.createElement('script'); s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js';
    document.head.appendChild(s); await new Promise(r => s.onload = r);
  }
  try {
    const pdf = await PDFLib.PDFDocument.create();
    for (const file of files) {
      const ab = await file.arrayBuffer();
      let img;
      if (file.type === 'image/png') img = await pdf.embedPng(ab);
      else img = await pdf.embedJpg(ab);
      const page = pdf.addPage([img.width, img.height]);
      page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
    }
    const bytes = await pdf.save();
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    document.getElementById('pdfImgResult').innerHTML = `<p style="color:var(--green)">‚úì Created PDF with ${files.length} image(s)</p><a href="${url}" download="images.pdf" class="btn btn-primary">‚¨á Download PDF</a>`;
    document.getElementById('pdfImgResult').classList.add('active');
  } catch(e) { showToast('Error: ' + e.message); }
}

// =====================================================
// 2. DATE & TIME TOOLS
// =====================================================
function initDateTools() {
  const update = () => { const el = document.getElementById('dtNow'); if (el) el.textContent = Math.floor(Date.now()/1000); };
  update(); setInterval(update, 1000);
}
function ts2date() {
  const ts = parseInt(document.getElementById('dtTs2Date').value);
  if (isNaN(ts)) return;
  const d = new Date(ts * (ts > 1e12 ? 1 : 1000));
  document.getElementById('dtTs2DateResult').textContent = d.toString();
}
function date2ts() {
  const v = document.getElementById('dtDate2Ts').value;
  if (!v) return;
  const ts = Math.floor(new Date(v).getTime() / 1000);
  document.getElementById('dtDate2TsResult').textContent = 'Unix Timestamp: ' + ts;
}
function calcAge() {
  const birth = new Date(document.getElementById('dtBirth').value);
  if (isNaN(birth)) return;
  const now = new Date();
  let years = now.getFullYear() - birth.getFullYear();
  let months = now.getMonth() - birth.getMonth();
  let days = now.getDate() - birth.getDate();
  if (days < 0) { months--; days += new Date(now.getFullYear(), now.getMonth(), 0).getDate(); }
  if (months < 0) { years--; months += 12; }
  const totalDays = Math.floor((now - birth) / 86400000);
  document.getElementById('dtAgeResult').innerHTML = `üéÇ <strong>${years} years, ${months} months, ${days} days</strong><br><span style="color:var(--text2);font-size:13px">That's ${totalDays.toLocaleString()} days or ${(totalDays*24).toLocaleString()} hours</span>`;
}
function calcDateDiff() {
  const a = new Date(document.getElementById('dtStart').value), b = new Date(document.getElementById('dtEnd').value);
  if (isNaN(a) || isNaN(b)) return;
  const diff = Math.abs(b - a);
  const days = Math.floor(diff / 86400000);
  const weeks = Math.floor(days / 7);
  const months = Math.round(days / 30.44);
  document.getElementById('dtDiffResult').innerHTML = `üìÖ <strong>${days} days</strong> (${weeks} weeks, or ~${months} months)<br><span style="color:var(--text2);font-size:13px">${(days*24).toLocaleString()} hours ¬∑ ${(days*1440).toLocaleString()} minutes</span>`;
}
var countdownInterval = null;
function startCountdown() {
  const target = new Date(document.getElementById('dtTarget').value);
  if (isNaN(target)) return;
  const el = document.getElementById('dtCountdownDisplay');
  el.style.display = 'block';
  if (countdownInterval) clearInterval(countdownInterval);
  countdownInterval = setInterval(() => {
    const diff = target - new Date();
    if (diff <= 0) { el.textContent = 'üéâ Time is up!'; clearInterval(countdownInterval); return; }
    const d = Math.floor(diff/86400000), h = Math.floor(diff%86400000/3600000), m = Math.floor(diff%3600000/60000), s = Math.floor(diff%60000/1000);
    el.textContent = `${d}d ${h}h ${m}m ${s}s`;
  }, 1000);
}

// =====================================================
// 3. CURRENCY CONVERTER
// =====================================================
var curRates = null;
async function initCurrency() {
  const from = document.getElementById('curFrom'), to = document.getElementById('curTo');
  if (!from) return;
  try {
    const resp = await fetch('https://open.er-api.com/v6/latest/USD');
    const data = await resp.json();
    curRates = data.rates;
    const popular = ['USD','EUR','GBP','BRL','JPY','CNY','CAD','AUD','CHF','INR','MXN','KRW','ARS','CLP','COP'];
    const all = Object.keys(curRates).sort();
    const opts = c => `<option value="${c}" ${c==='USD'?'selected':''}>${c}</option>`;
    const optStr = popular.map(opts).join('') + '<option disabled>‚îÄ‚îÄ‚îÄ</option>' + all.filter(c=>!popular.includes(c)).map(opts).join('');
    from.innerHTML = optStr;
    to.innerHTML = optStr.replace('selected','');
    to.value = 'BRL';
    convertCurrency();
  } catch(e) { document.getElementById('curResult').textContent = 'Failed to load rates'; }
}
function convertCurrency() {
  if (!curRates) return;
  const amt = parseFloat(document.getElementById('curAmt').value) || 0;
  const from = document.getElementById('curFrom').value, to = document.getElementById('curTo').value;
  const result = amt / curRates[from] * curRates[to];
  document.getElementById('curResult').textContent = `${amt.toLocaleString()} ${from} = ${result.toLocaleString(undefined,{maximumFractionDigits:4})} ${to}`;
  document.getElementById('curRate').textContent = `1 ${from} = ${(curRates[to]/curRates[from]).toFixed(6)} ${to} ¬∑ Rates from open.er-api.com`;
}
function swapCurrency() {
  const f = document.getElementById('curFrom'), t = document.getElementById('curTo');
  const tmp = f.value; f.value = t.value; t.value = tmp;
  convertCurrency();
}

// =====================================================
// 4. IP LOOKUP
// =====================================================
async function initIpLookup() {
  try {
    const resp = await fetch('https://ipapi.co/json/');
    const d = await resp.json();
    document.getElementById('ipDisplay').textContent = d.ip;
    document.getElementById('ipDetails').innerHTML = [
      ['üåç Location', `${d.city}, ${d.region}, ${d.country_name}`],
      ['üè¢ ISP', d.org],
      ['üì° Network', d.asn],
      ['üïê Timezone', d.timezone],
      ['üìç Coordinates', `${d.latitude}, ${d.longitude}`],
      ['üìÆ Postal', d.postal]
    ].map(([l,v]) => `<div class="stat-box"><div class="label">${l}</div><div class="value" style="font-size:14px">${v||'N/A'}</div></div>`).join('');
  } catch(e) { document.getElementById('ipDisplay').textContent = 'Failed to detect'; }
}
async function lookupIp() {
  const ip = document.getElementById('ipLookupInput').value.trim();
  if (!ip) return;
  try {
    const resp = await fetch('https://ipapi.co/' + ip + '/json/');
    const d = await resp.json();
    if (d.error) throw new Error(d.reason);
    document.getElementById('ipLookupResult').innerHTML = `<p style="color:var(--green)">‚úì ${d.ip}</p><p style="font-size:13px">Location: ${d.city}, ${d.region}, ${d.country_name}<br>ISP: ${d.org}<br>Timezone: ${d.timezone}<br>Coordinates: ${d.latitude}, ${d.longitude}</p>`;
    document.getElementById('ipLookupResult').classList.add('active');
  } catch(e) { showToast('Lookup failed: ' + e.message); }
}

// =====================================================
// 5. TEXT DIFF
// =====================================================
function runDiff() {
  const a = document.getElementById('diffA').value, b = document.getElementById('diffB').value;
  if (!a && !b) { document.getElementById('diffOutput').innerHTML = ''; document.getElementById('diffStats').textContent = ''; return; }
  const linesA = a.split('\n'), linesB = b.split('\n');
  let html = '', added = 0, removed = 0, same = 0;
  const maxLen = Math.max(linesA.length, linesB.length);
  for (let i = 0; i < maxLen; i++) {
    const la = linesA[i], lb = linesB[i];
    if (la === lb) { html += `<span style="color:var(--text2)">${escHtml(la || '')}</span>\n`; same++; }
    else {
      if (la !== undefined) { html += `<span style="background:rgba(255,50,50,.15);color:#ff6b6b">- ${escHtml(la)}</span>\n`; removed++; }
      if (lb !== undefined) { html += `<span style="background:rgba(50,255,50,.15);color:#51cf66">+ ${escHtml(lb)}</span>\n`; added++; }
    }
  }
  document.getElementById('diffOutput').innerHTML = html;
  document.getElementById('diffStats').innerHTML = `<span style="color:var(--green)">+${added} added</span> ¬∑ <span style="color:var(--red)">-${removed} removed</span> ¬∑ ${same} unchanged`;
}
function escHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

// =====================================================
// 6. CSS GRADIENT GENERATOR
// =====================================================
function updateGrad() {
  const type = document.getElementById('gradType').value;
  const ang = document.getElementById('gradAng').value;
  document.getElementById('gradAngV').textContent = ang;
  const c1 = document.getElementById('gradC1').value, c2 = document.getElementById('gradC2').value, c3 = document.getElementById('gradC3').value;
  const use3 = document.getElementById('gradUse3').checked;
  const colors = use3 ? `${c1}, ${c2}, ${c3}` : `${c1}, ${c2}`;
  let css;
  if (type === 'linear') css = `linear-gradient(${ang}deg, ${colors})`;
  else if (type === 'radial') css = `radial-gradient(circle, ${colors})`;
  else css = `conic-gradient(from ${ang}deg, ${colors})`;
  document.getElementById('gradPreview').style.background = css;
  document.getElementById('gradCSS').value = `background: ${css};`;
}

// =====================================================
// 7. POMODORO TIMER
// =====================================================
var pomInterval = null, pomRunning = false, pomSeconds = 0, pomIsWork = true, pomSession = 1;
function pomToggle() {
  if (pomRunning) {
    clearInterval(pomInterval); pomRunning = false;
    document.getElementById('pomStartBtn').textContent = '‚ñ∂ Start';
  } else {
    if (pomSeconds === 0) pomSeconds = parseInt(document.getElementById('pomWork').value) * 60;
    pomRunning = true;
    document.getElementById('pomStartBtn').textContent = '‚è∏ Pause';
    pomInterval = setInterval(() => {
      pomSeconds--;
      pomUpdateDisplay();
      if (pomSeconds <= 0) pomNext();
    }, 1000);
  }
}
function pomUpdateDisplay() {
  const m = Math.floor(pomSeconds / 60), s = pomSeconds % 60;
  document.getElementById('pomDisplay').textContent = String(m).padStart(2,'0') + ':' + String(s).padStart(2,'0');
}
function pomNext() {
  clearInterval(pomInterval); pomRunning = false;
  // Beep
  try { const ctx = new AudioContext(); const osc = ctx.createOscillator(); osc.connect(ctx.destination); osc.frequency.value = 800; osc.start(); setTimeout(()=>{osc.stop();ctx.close()},300); } catch(e){}
  if (pomIsWork) {
    pomIsWork = false;
    const isLong = pomSession % 4 === 0;
    pomSeconds = parseInt(document.getElementById(isLong ? 'pomLong' : 'pomBreak').value) * 60;
    document.getElementById('pomPhase').textContent = isLong ? '‚òï LONG BREAK' : '‚òï SHORT BREAK';
    document.getElementById('pomPhase').style.color = 'var(--green)';
  } else {
    pomIsWork = true; pomSession++;
    pomSeconds = parseInt(document.getElementById('pomWork').value) * 60;
    document.getElementById('pomPhase').textContent = 'üî• WORK';
    document.getElementById('pomPhase').style.color = 'var(--accent2)';
    document.getElementById('pomSession').textContent = pomSession;
  }
  pomUpdateDisplay();
  document.getElementById('pomStartBtn').textContent = '‚ñ∂ Start';
}
function pomReset() {
  clearInterval(pomInterval); pomRunning = false; pomIsWork = true; pomSession = 1;
  pomSeconds = parseInt(document.getElementById('pomWork').value) * 60;
  pomUpdateDisplay();
  document.getElementById('pomPhase').textContent = 'WORK';
  document.getElementById('pomPhase').style.color = 'var(--accent2)';
  document.getElementById('pomSession').textContent = '1';
  document.getElementById('pomStartBtn').textContent = '‚ñ∂ Start';
}
function pomSkip() { pomSeconds = 0; pomNext(); }

// =====================================================
// 8. URL TOOLS
// =====================================================
function urlDoEnc() { document.getElementById('urlEncOutput').value = encodeURIComponent(document.getElementById('urlEncInput').value); }
function urlDoDec() { try { document.getElementById('urlEncOutput').value = decodeURIComponent(document.getElementById('urlEncInput').value); } catch(e) { showToast('Invalid encoded URL'); } }
function parseUrl() {
  const v = document.getElementById('urlParseInput').value;
  if (!v) { document.getElementById('urlParseResult').innerHTML = ''; return; }
  try {
    const u = new URL(v);
    let params = '';
    u.searchParams.forEach((val,key) => { params += `<tr><td style="padding:4px 12px 4px 0;color:var(--accent2)">${escHtml(key)}</td><td style="padding:4px 0">${escHtml(val)}</td></tr>`; });
    document.getElementById('urlParseResult').innerHTML = `<table style="width:100%;border-collapse:collapse;margin-top:12px">
      <tr><td style="padding:4px 12px 4px 0;color:var(--text2);font-weight:600">Protocol</td><td>${u.protocol}</td></tr>
      <tr><td style="padding:4px 12px 4px 0;color:var(--text2);font-weight:600">Host</td><td>${u.host}</td></tr>
      <tr><td style="padding:4px 12px 4px 0;color:var(--text2);font-weight:600">Pathname</td><td>${u.pathname}</td></tr>
      <tr><td style="padding:4px 12px 4px 0;color:var(--text2);font-weight:600">Hash</td><td>${u.hash || '‚Äî'}</td></tr>
      ${params ? '<tr><td colspan="2" style="padding:12px 0 4px;color:var(--text2);font-weight:600">Query Parameters</td></tr>' + params : ''}
    </table>`;
  } catch(e) { document.getElementById('urlParseResult').innerHTML = '<p style="color:var(--red)">Invalid URL</p>'; }
}
function urlToQr() {
  const url = document.getElementById('urlQrInput').value;
  if (!url) { showToast('Enter a URL first'); return; }
  const container = document.getElementById('urlQrCanvas').parentElement;
  container.innerHTML = '<div id="urlQrOut"></div>';
  new QRCode(document.getElementById('urlQrOut'), { text: url, width: 256, height: 256, colorDark: '#000000', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
}

// =====================================================
// TOOL INITIALIZERS (called on modal open)
// =====================================================
const toolInits = {
  'date-tools': initDateTools,
  'currency': initCurrency,
  'ip-lookup': initIpLookup,
  'gradient-gen': updateGrad,
  'pomodoro': () => { pomReset(); },
};

// =====================================================
// SHARED IMAGE HELPERS
// =====================================================
function loadImgToCanvas(file, canvasId, cb) {
  const r = new FileReader();
  r.onload = function(e) {
    const img = new Image();
    img.onload = function() { cb(img); };
    img.src = e.target.result;
  };
  r.readAsDataURL(file);
}
function downloadCanvas(id, fname) {
  const c = document.getElementById(id);
  const a = document.createElement('a');
  a.href = c.toDataURL('image/png');
  a.download = fname || 'image.png';
  a.click();
}

// =====================================================
// 1. PHOTO FILTERS
// =====================================================
var pfOrigImg = null;
const PF_FILTERS = [
  { name:'None', fn: d => d },
  { name:'B&W', fn: d => { for(let i=0;i<d.length;i+=4){ const g=d[i]*.3+d[i+1]*.59+d[i+2]*.11; d[i]=d[i+1]=d[i+2]=g; } return d; }},
  { name:'Sepia', fn: d => { for(let i=0;i<d.length;i+=4){ const r=d[i],g=d[i+1],b=d[i+2]; d[i]=Math.min(255,r*.393+g*.769+b*.189); d[i+1]=Math.min(255,r*.349+g*.686+b*.168); d[i+2]=Math.min(255,r*.272+g*.534+b*.131); } return d; }},
  { name:'Warm', fn: d => { for(let i=0;i<d.length;i+=4){ d[i]=Math.min(255,d[i]+25); d[i+2]=Math.max(0,d[i+2]-20); } return d; }},
  { name:'Cold', fn: d => { for(let i=0;i<d.length;i+=4){ d[i]=Math.max(0,d[i]-20); d[i+2]=Math.min(255,d[i+2]+25); } return d; }},
  { name:'Vintage', fn: d => { for(let i=0;i<d.length;i+=4){ d[i]=Math.min(255,d[i]*1.1+20); d[i+1]=Math.min(255,d[i+1]*.9+15); d[i+2]=Math.min(255,d[i+2]*.7+10); } return d; }},
  { name:'Dramatic', fn: d => { for(let i=0;i<d.length;i+=4){ for(let c=0;c<3;c++){ let v=d[i+c]/255; v=((v-.5)*1.6+.5)*255; d[i+c]=Math.max(0,Math.min(255,v)); } d[i]=Math.min(255,d[i]+10); } return d; }},
  { name:'Faded', fn: d => { for(let i=0;i<d.length;i+=4){ for(let c=0;c<3;c++) d[i+c]=d[i+c]*.85+30; } return d; }},
  { name:'High Contrast', fn: d => { for(let i=0;i<d.length;i+=4){ for(let c=0;c<3;c++){ d[i+c]=Math.max(0,Math.min(255,((d[i+c]/255-.5)*2+.5)*255)); } } return d; }},
  { name:'Lomo', fn: d => { for(let i=0;i<d.length;i+=4){ d[i]=Math.min(255,d[i]*1.15); d[i+1]*=.95; d[i+2]=Math.min(255,d[i+2]*1.2); } return d; }},
];
function loadPhotoFilter(file) {
  if (!file) return;
  loadImgToCanvas(file, 'pfCanvas', function(img) {
    pfOrigImg = img;
    const btns = document.getElementById('pfFilterBtns');
    btns.innerHTML = PF_FILTERS.map((f,i) => `<button class="btn btn-secondary" style="padding:6px 14px;font-size:12px" onclick="applyPhotoFilter(${i})">${f.name}</button>`).join('');
    document.getElementById('pfLoaded').style.display = 'block';
    applyPhotoFilter(0);
  });
}
function applyPhotoFilter(idx) {
  if (!pfOrigImg) return;
  if (idx === 'none') idx = 0;
  const c = document.getElementById('pfCanvas');
  c.width = pfOrigImg.width; c.height = pfOrigImg.height;
  const ctx = c.getContext('2d');
  ctx.drawImage(pfOrigImg, 0, 0);
  if (idx > 0) {
    const imgData = ctx.getImageData(0, 0, c.width, c.height);
    PF_FILTERS[idx].fn(imgData.data);
    ctx.putImageData(imgData, 0, 0);
  }
}

// =====================================================
// 2. IMAGE ADJUSTMENTS
// =====================================================
var adjOrigImg = null;
function loadAdjust(file) {
  if (!file) return;
  loadImgToCanvas(file, 'adjCanvas', function(img) {
    adjOrigImg = img;
    document.getElementById('adjLoaded').style.display = 'block';
    applyAdj();
  });
}
function resetAdj() {
  ['adjBright','adjContrast','adjSat','adjTemp','adjBlur','adjVig'].forEach(id => document.getElementById(id).value = 0);
  applyAdj();
}
function applyAdj() {
  if (!adjOrigImg) return;
  const c = document.getElementById('adjCanvas');
  c.width = adjOrigImg.width; c.height = adjOrigImg.height;
  const ctx = c.getContext('2d');
  const bright = parseInt(document.getElementById('adjBright').value);
  const contrast = parseInt(document.getElementById('adjContrast').value);
  const sat = parseInt(document.getElementById('adjSat').value);
  const temp = parseInt(document.getElementById('adjTemp').value);
  const blur = parseInt(document.getElementById('adjBlur').value);
  const vig = parseInt(document.getElementById('adjVig').value);
  document.getElementById('adjBrightV').textContent = bright;
  document.getElementById('adjContrastV').textContent = contrast;
  document.getElementById('adjSatV').textContent = sat;
  document.getElementById('adjTempV').textContent = temp;
  document.getElementById('adjBlurV').textContent = blur;
  document.getElementById('adjVigV').textContent = vig;
  ctx.filter = `brightness(${100+bright}%) contrast(${100+contrast}%) saturate(${100+sat}%) blur(${blur}px)`;
  ctx.drawImage(adjOrigImg, 0, 0);
  ctx.filter = 'none';
  if (temp !== 0 || vig > 0) {
    const imgData = ctx.getImageData(0, 0, c.width, c.height);
    const d = imgData.data;
    if (temp !== 0) { for (let i=0; i<d.length; i+=4) { d[i]=Math.max(0,Math.min(255,d[i]+temp)); d[i+2]=Math.max(0,Math.min(255,d[i+2]-temp)); } }
    if (vig > 0) {
      const cx=c.width/2, cy=c.height/2, maxR=Math.sqrt(cx*cx+cy*cy);
      for (let y=0; y<c.height; y++) for (let x=0; x<c.width; x++) {
        const dist = Math.sqrt((x-cx)**2+(y-cy)**2)/maxR;
        const f = 1 - dist*dist*(vig/100);
        const idx = (y*c.width+x)*4;
        d[idx]*=f; d[idx+1]*=f; d[idx+2]*=f;
      }
    }
    ctx.putImageData(imgData, 0, 0);
  }
}

// =====================================================
// 3. CROP & ROTATE
// =====================================================
var cropOrigImg = null, cropRatio = 'free';
function loadCrop(file) {
  if (!file) return;
  loadImgToCanvas(file, 'cropCanvas', function(img) {
    cropOrigImg = img;
    document.getElementById('cropW').value = img.width;
    document.getElementById('cropH').value = img.height;
    document.getElementById('cropX').value = 0;
    document.getElementById('cropY').value = 0;
    document.getElementById('rotSlider').value = 0;
    document.getElementById('cropLoaded').style.display = 'block';
    updateCropPreview();
  });
}
function setCropRatio(r) {
  cropRatio = r;
  if (r !== 'free' && cropOrigImg) {
    const w = parseInt(document.getElementById('cropW').value);
    document.getElementById('cropH').value = Math.round(w / r);
  }
  updateCropPreview();
}
function updateCropPreview() {
  if (!cropOrigImg) return;
  const rot = parseInt(document.getElementById('rotSlider').value);
  document.getElementById('rotValLabel').textContent = rot + '¬∞';
  const c = document.getElementById('cropCanvas');
  const rad = rot * Math.PI / 180;
  const w = cropOrigImg.width, h = cropOrigImg.height;
  const absC = Math.abs(Math.cos(rad)), absS = Math.abs(Math.sin(rad));
  c.width = Math.ceil(w * absC + h * absS);
  c.height = Math.ceil(w * absS + h * absC);
  const ctx = c.getContext('2d');
  ctx.fillStyle = '#1a1a22';
  ctx.fillRect(0, 0, c.width, c.height);
  ctx.save();
  ctx.translate(c.width/2, c.height/2);
  ctx.rotate(rad);
  ctx.drawImage(cropOrigImg, -w/2, -h/2);
  ctx.restore();
  // Draw crop rectangle overlay
  const cx = parseInt(document.getElementById('cropX').value) || 0;
  const cy = parseInt(document.getElementById('cropY').value) || 0;
  const cw = parseInt(document.getElementById('cropW').value) || c.width;
  const ch = parseInt(document.getElementById('cropH').value) || c.height;
  ctx.fillStyle = 'rgba(0,0,0,0.5)';
  ctx.fillRect(0, 0, c.width, cy);
  ctx.fillRect(0, cy+ch, c.width, c.height-cy-ch);
  ctx.fillRect(0, cy, cx, ch);
  ctx.fillRect(cx+cw, cy, c.width-cx-cw, ch);
  ctx.strokeStyle = '#6c5ce7'; ctx.lineWidth = 2; ctx.setLineDash([6,4]);
  ctx.strokeRect(cx, cy, cw, ch);
  ctx.setLineDash([]);
}
function doCrop() {
  if (!cropOrigImg) return;
  const rot = parseInt(document.getElementById('rotSlider').value) * Math.PI / 180;
  const w = cropOrigImg.width, h = cropOrigImg.height;
  const absC = Math.abs(Math.cos(rot)), absS = Math.abs(Math.sin(rot));
  const rw = Math.ceil(w*absC+h*absS), rh = Math.ceil(w*absS+h*absC);
  // Draw rotated full image to temp
  const tmp = document.createElement('canvas');
  tmp.width = rw; tmp.height = rh;
  const tc = tmp.getContext('2d');
  tc.translate(rw/2, rh/2); tc.rotate(rot);
  tc.drawImage(cropOrigImg, -w/2, -h/2);
  // Crop region
  const cx=parseInt(document.getElementById('cropX').value)||0, cy=parseInt(document.getElementById('cropY').value)||0;
  const cw=parseInt(document.getElementById('cropW').value)||rw, ch=parseInt(document.getElementById('cropH').value)||rh;
  const out = document.getElementById('cropOut');
  out.width = cw; out.height = ch;
  out.getContext('2d').drawImage(tmp, cx, cy, cw, ch, 0, 0, cw, ch);
  document.getElementById('cropResult').classList.add('active');
}

// =====================================================
// 4. ADD TEXT TO IMAGE
// =====================================================
var textOrigImg = null;
function loadTextImg(file) {
  if (!file) return;
  loadImgToCanvas(file, 'textCanvas', function(img) {
    textOrigImg = img;
    document.getElementById('textImgLoaded').style.display = 'block';
    drawTextPreview();
  });
}
function drawTextPreview() {
  if (!textOrigImg) return;
  const c = document.getElementById('textCanvas');
  c.width = textOrigImg.width; c.height = textOrigImg.height;
  const ctx = c.getContext('2d');
  ctx.drawImage(textOrigImg, 0, 0);
  const txt = document.getElementById('txtContent').value;
  const font = document.getElementById('txtFont').value;
  const size = parseInt(document.getElementById('txtSize').value) || 48;
  const color = document.getElementById('txtColor').value;
  const xPct = parseInt(document.getElementById('txtX').value) / 100;
  const yPct = parseInt(document.getElementById('txtY').value) / 100;
  const shadow = document.getElementById('txtShadow').checked;
  const bold = document.getElementById('txtBold').checked;
  ctx.font = (bold ? 'bold ' : '') + size + 'px "' + font + '"';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  const x = c.width * xPct, y = c.height * yPct;
  if (shadow) { ctx.shadowColor = 'rgba(0,0,0,0.7)'; ctx.shadowBlur = size/4; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2; }
  ctx.fillStyle = color;
  ctx.fillText(txt, x, y);
  ctx.shadowColor = 'transparent';
}

// =====================================================
// 5. COLLAGE MAKER
// =====================================================
var collageImages = [];
function loadCollage(files) {
  if (!files || !files.length) return;
  collageImages = [];
  let loaded = 0;
  for (let i = 0; i < Math.min(files.length, 6); i++) {
    const img = new Image();
    const r = new FileReader();
    r.onload = function(e) {
      img.onload = function() {
        collageImages[i] = img;
        loaded++;
        if (loaded === Math.min(files.length, 6)) showToast(loaded + ' images loaded');
      };
      img.src = e.target.result;
    };
    r.readAsDataURL(files[i]);
  }
}
function makeCollage() {
  if (collageImages.length < 2) { showToast('Upload at least 2 images'); return; }
  const layout = document.getElementById('collageLayout').value;
  const gap = parseInt(document.getElementById('collageGap').value) || 0;
  const bg = document.getElementById('collageBg').value;
  const [cols, rows] = layout.split('x').map(Number);
  const cellW = 400, cellH = 400;
  const c = document.getElementById('collageCanvas');
  c.width = cols * cellW + (cols + 1) * gap;
  c.height = rows * cellH + (rows + 1) * gap;
  const ctx = c.getContext('2d');
  ctx.fillStyle = bg; ctx.fillRect(0, 0, c.width, c.height);
  let idx = 0;
  for (let r = 0; r < rows; r++) {
    for (let co = 0; co < cols; co++) {
      if (idx >= collageImages.length) break;
      const img = collageImages[idx];
      const x = gap + co * (cellW + gap), y = gap + r * (cellH + gap);
      // Cover fit
      const scale = Math.max(cellW / img.width, cellH / img.height);
      const sw = cellW / scale, sh = cellH / scale;
      const sx = (img.width - sw) / 2, sy = (img.height - sh) / 2;
      ctx.drawImage(img, sx, sy, sw, sh, x, y, cellW, cellH);
      idx++;
    }
  }
  document.getElementById('collageResult').classList.add('active');
}

// =====================================================
// 6. CREATIVE EFFECTS
// =====================================================
var cfxOrigImg = null;
function loadCfx(file) {
  if (!file) return;
  loadImgToCanvas(file, 'cfxCanvas', function(img) {
    cfxOrigImg = img;
    document.getElementById('cfxLoaded').style.display = 'block';
    applyCfx();
  });
}
function applyCfx(reset) {
  if (!cfxOrigImg) return;
  const c = document.getElementById('cfxCanvas');
  c.width = cfxOrigImg.width; c.height = cfxOrigImg.height;
  const ctx = c.getContext('2d');
  ctx.drawImage(cfxOrigImg, 0, 0);
  if (reset === 'none') return;
  const type = document.getElementById('cfxType').value;
  const int = parseInt(document.getElementById('cfxInt').value) / 100;
  document.getElementById('cfxDuotoneColors').style.display = type === 'duotone' ? 'block' : 'none';
  const imgData = ctx.getImageData(0, 0, c.width, c.height);
  const d = imgData.data;
  if (type === 'pixelate') {
    const ps = Math.max(2, Math.round(int * 40));
    for (let y = 0; y < c.height; y += ps) for (let x = 0; x < c.width; x += ps) {
      const i = (y * c.width + x) * 4;
      ctx.fillStyle = `rgb(${d[i]},${d[i+1]},${d[i+2]})`;
      ctx.fillRect(x, y, ps, ps);
    }
    return; // already drawn to canvas
  } else if (type === 'glitch') {
    const slices = Math.round(5 + int * 30);
    const sh = Math.ceil(c.height / slices);
    for (let i = 0; i < slices; i++) {
      const offset = (Math.random() - 0.5) * int * 60;
      ctx.drawImage(c, 0, i*sh, c.width, sh, offset, i*sh, c.width, sh);
    }
    // Color channel shift
    const gd = ctx.getImageData(0, 0, c.width, c.height);
    const shift = Math.round(int * 15);
    for (let i = 0; i < gd.data.length; i += 4) {
      gd.data[i] = d[Math.min(i + shift * 4, d.length - 4)] || d[i]; // shift red
    }
    ctx.putImageData(gd, 0, 0);
    return;
  } else if (type === 'posterize') {
    const levels = Math.max(2, Math.round(8 - int * 6));
    for (let i = 0; i < d.length; i += 4) { for (let c = 0; c < 3; c++) d[i+c] = Math.round(d[i+c] / 255 * levels) / levels * 255; }
  } else if (type === 'duotone') {
    const c1 = document.getElementById('cfxDuo1').value, c2 = document.getElementById('cfxDuo2').value;
    const r1=parseInt(c1.slice(1,3),16),g1=parseInt(c1.slice(3,5),16),b1=parseInt(c1.slice(5,7),16);
    const r2=parseInt(c2.slice(1,3),16),g2=parseInt(c2.slice(3,5),16),b2=parseInt(c2.slice(5,7),16);
    for (let i = 0; i < d.length; i += 4) {
      const gray = (d[i]*.3+d[i+1]*.59+d[i+2]*.11)/255;
      d[i] = r1*(1-gray)+r2*gray; d[i+1] = g1*(1-gray)+g2*gray; d[i+2] = b1*(1-gray)+b2*gray;
    }
  } else if (type === 'noise') {
    const strength = int * 100;
    for (let i = 0; i < d.length; i += 4) { const n = (Math.random()-.5)*strength; d[i]+=n; d[i+1]+=n; d[i+2]+=n; }
  } else if (type === 'invert') {
    for (let i = 0; i < d.length; i += 4) { d[i]=255-d[i]; d[i+1]=255-d[i+1]; d[i+2]=255-d[i+2]; }
  } else if (type === 'emboss') {
    const w4 = c.width * 4;
    const od = new Uint8ClampedArray(d);
    for (let i = w4 + 4; i < d.length - w4 - 4; i += 4) {
      for (let c = 0; c < 3; c++) d[i+c] = 128 + (od[i+c+4]-od[i+c-4])*int*3 + (od[i+c+w4]-od[i+c-w4])*int*3;
    }
  }
  ctx.putImageData(imgData, 0, 0);
}

// =====================================================
// 7. REMOVE BACKGROUND
// =====================================================
var bgOrigImg = null, bgOrigData = null;
function loadBg(file) {
  if (!file) return;
  loadImgToCanvas(file, 'bgCanvas', function(img) {
    bgOrigImg = img;
    const c = document.getElementById('bgCanvas');
    c.width = img.width; c.height = img.height;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0);
    bgOrigData = ctx.getImageData(0, 0, c.width, c.height);
    document.getElementById('bgLoaded').style.display = 'block';
  });
}
function pickBgColor(e) {
  const c = document.getElementById('bgCanvas');
  const rect = c.getBoundingClientRect();
  const scaleX = c.width / rect.width, scaleY = c.height / rect.height;
  const x = Math.round((e.clientX - rect.left) * scaleX);
  const y = Math.round((e.clientY - rect.top) * scaleY);
  const ctx = c.getContext('2d');
  // Re-draw original first to pick from it
  ctx.putImageData(bgOrigData, 0, 0);
  const px = ctx.getImageData(x, y, 1, 1).data;
  const hex = '#' + [px[0],px[1],px[2]].map(v => v.toString(16).padStart(2,'0')).join('');
  document.getElementById('bgColor').value = hex;
  removeBg();
}
function removeBg() {
  if (!bgOrigData) return;
  const c = document.getElementById('bgCanvas');
  const ctx = c.getContext('2d');
  const imgData = new ImageData(new Uint8ClampedArray(bgOrigData.data), bgOrigData.width, bgOrigData.height);
  const d = imgData.data;
  const col = document.getElementById('bgColor').value;
  const tr = parseInt(col.slice(1,3),16), tg = parseInt(col.slice(3,5),16), tb = parseInt(col.slice(5,7),16);
  const tol = parseInt(document.getElementById('bgTol').value);
  for (let i = 0; i < d.length; i += 4) {
    const dist = Math.sqrt((d[i]-tr)**2 + (d[i+1]-tg)**2 + (d[i+2]-tb)**2);
    if (dist < tol * 4.42) { // max dist ~442 -> normalized
      d[i+3] = 0; // set alpha to 0
    }
  }
  ctx.clearRect(0, 0, c.width, c.height);
  ctx.putImageData(imgData, 0, 0);
}

// =====================================================
// 8. SCREENSHOT BEAUTIFIER
// =====================================================
var ssOrigImg = null;
function loadSS(file) {
  if (!file) return;
  loadImgToCanvas(file, 'ssCanvas', function(img) {
    ssOrigImg = img;
    document.getElementById('ssLoaded').style.display = 'block';
    renderSS();
  });
}
function renderSS() {
  if (!ssOrigImg) return;
  const c = document.getElementById('ssCanvas');
  const ctx = c.getContext('2d');
  const pad = parseInt(document.getElementById('ssPad').value);
  const rad = parseInt(document.getElementById('ssRad').value);
  const shad = parseInt(document.getElementById('ssShad').value);
  const bgStr = document.getElementById('ssBg').value;
  const iw = ssOrigImg.width, ih = ssOrigImg.height;
  // Scale down if too large
  const maxW = 1200;
  const scale = iw > maxW ? maxW / iw : 1;
  const sw = Math.round(iw * scale), sh = Math.round(ih * scale);
  c.width = sw + pad * 2; c.height = sh + pad * 2;
  // Draw gradient background
  if (bgStr.startsWith('linear-gradient')) {
    const colors = bgStr.match(/#[0-9a-fA-F]{6}/g) || ['#667eea', '#764ba2'];
    const grad = ctx.createLinearGradient(0, 0, c.width, c.height);
    grad.addColorStop(0, colors[0]); grad.addColorStop(1, colors[1] || colors[0]);
    ctx.fillStyle = grad;
  } else {
    ctx.fillStyle = bgStr;
  }
  ctx.fillRect(0, 0, c.width, c.height);
  // Shadow
  if (shad > 0) {
    ctx.shadowColor = 'rgba(0,0,0,0.4)';
    ctx.shadowBlur = shad;
    ctx.shadowOffsetX = 0;
    ctx.shadowOffsetY = shad / 3;
  }
  // Rounded rectangle clip for the screenshot
  const x = pad, y = pad;
  ctx.beginPath();
  ctx.roundRect(x, y, sw, sh, rad);
  ctx.fillStyle = '#fff';
  ctx.fill();
  ctx.shadowColor = 'transparent';
  ctx.save();
  ctx.beginPath();
  ctx.roundRect(x, y, sw, sh, rad);
  ctx.clip();
  ctx.drawImage(ssOrigImg, x, y, sw, sh);
  ctx.restore();
}

// =====================================================
// AUDIO UTILITIES
// =====================================================
function statusMsg(id,msg,col){const el=document.getElementById(id);if(el){el.textContent=msg;el.style.color=col||'var(--text2)'}}
function readFileAsArrayBuffer(file){return new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=()=>rej(new Error('File read error'));r.readAsArrayBuffer(file)})}
async function decodeAudio(ab){const ctx=new(window.AudioContext||window.webkitAudioContext)();try{if(ctx.state==='suspended')await ctx.resume();return await ctx.decodeAudioData(ab)}finally{ctx.close()}}
function encodeWav(chData,numCh,sr){const len=chData[0].length;const bps=2;let samples;if(numCh===2&&chData.length>=2){samples=new Float32Array(len*2);for(let i=0;i<len;i++){samples[i*2]=chData[0][i];samples[i*2+1]=chData[1][i]}}else{samples=chData[0];numCh=1}const dLen=samples.length*bps;const buf=new ArrayBuffer(44+dLen);const v=new DataView(buf);const w=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i))};w(0,'RIFF');v.setUint32(4,36+dLen,true);w(8,'WAVE');w(12,'fmt ');v.setUint32(16,16,true);v.setUint16(20,1,true);v.setUint16(22,numCh,true);v.setUint32(24,sr,true);v.setUint32(28,sr*numCh*bps,true);v.setUint16(32,numCh*bps,true);v.setUint16(34,16,true);w(36,'data');v.setUint32(40,dLen,true);let off=44;for(let i=0;i<samples.length;i++,off+=2){const s=Math.max(-1,Math.min(1,samples[i]));v.setInt16(off,s<0?s*0x8000:s*0x7FFF,true)}return new Blob([buf],{type:'audio/wav'})}
function finishExport(blob,aId,lId,fname){const u=URL.createObjectURL(blob);document.getElementById(aId).src=u;const a=document.getElementById(lId);a.href=u;a.download=fname}
function normalize(channels){let mx=0;for(const ch of channels)for(let i=0;i<ch.length;i++){const a=Math.abs(ch[i]);if(a>mx)mx=a}if(mx>0){const g=0.9/mx;for(const ch of channels)for(let i=0;i<ch.length;i++)ch[i]*=g}return channels}

// =====================================================
// PHASE VOCODER ‚Äî proper time-stretching with pitch preservation
// =====================================================
function phaseVocoder(inputData, speed, fftSize) {
  fftSize = fftSize || 4096;
  const hopA = fftSize / 4; // analysis hop (fixed)
  const hopS = Math.round(hopA / speed); // synthesis hop
  const len = inputData.length;
  const outLen = Math.round(len / speed) + fftSize;
  const output = new Float32Array(outLen);
  const winSum = new Float32Array(outLen);
  
  // Hann window
  const win = new Float32Array(fftSize);
  for (let i = 0; i < fftSize; i++) win[i] = 0.5 * (1 - Math.cos(2 * Math.PI * i / fftSize));
  
  // Phase tracking arrays
  const phaseA = new Float32Array(fftSize); // last analysis phase
  const phaseS = new Float32Array(fftSize); // accumulated synthesis phase
  let firstFrame = true;
  
  let inPos = 0;
  let outPos = 0;
  
  while (inPos + fftSize <= len) {
    // Extract windowed frame
    const real = new Float32Array(fftSize);
    const imag = new Float32Array(fftSize);
    for (let i = 0; i < fftSize; i++) {
      real[i] = inputData[inPos + i] * win[i];
    }
    
    // Forward FFT
    fft(real, imag, false);
    
    // Phase vocoder processing for each bin
    for (let k = 0; k <= fftSize / 2; k++) {
      const mag = Math.sqrt(real[k] * real[k] + imag[k] * imag[k]);
      const phase = Math.atan2(imag[k], real[k]);
      
      if (firstFrame) {
        phaseS[k] = phase;
      } else {
        // Phase difference from last analysis frame
        let dp = phase - phaseA[k];
        
        // Expected phase advance for this bin
        const expected = 2 * Math.PI * k * hopA / fftSize;
        
        // Deviation from expected
        dp -= expected;
        
        // Wrap to [-PI, PI]
        dp = dp - 2 * Math.PI * Math.round(dp / (2 * Math.PI));
        
        // True instantaneous frequency (deviation)
        const instFreq = expected + dp;
        
        // Scale phase advance by synthesis/analysis hop ratio
        phaseS[k] += instFreq * (hopS / hopA);
      }
      
      phaseA[k] = phase;
      
      // Reconstruct with new phase
      real[k] = mag * Math.cos(phaseS[k]);
      imag[k] = mag * Math.sin(phaseS[k]);
      
      // Mirror for negative frequencies (conjugate symmetry)
      if (k > 0 && k < fftSize / 2) {
        real[fftSize - k] = real[k];
        imag[fftSize - k] = -imag[k];
      }
    }
    
    firstFrame = false;
    
    // Inverse FFT
    fft(real, imag, true);
    
    // Overlap-add with window
    for (let i = 0; i < fftSize; i++) {
      if (outPos + i < outLen) {
        output[outPos + i] += real[i] * win[i];
        winSum[outPos + i] += win[i] * win[i];
      }
    }
    
    inPos += hopA;
    outPos += hopS;
  }
  
  // Normalize by accumulated window energy
  const finalLen = Math.min(Math.round(len / speed), outLen);
  for (let i = 0; i < finalLen; i++) {
    if (winSum[i] > 1e-6) {
      output[i] /= winSum[i];
    }
  }
  
  return output.slice(0, finalLen);
}

// In-place Cooley-Tukey FFT
function fft(real, imag, inverse) {
  const n = real.length;
  const bits = Math.log2(n);
  
  // Bit reversal
  for (let i = 0; i < n; i++) {
    let j = 0;
    for (let b = 0; b < bits; b++) j = (j << 1) | ((i >> b) & 1);
    if (j > i) {
      [real[i], real[j]] = [real[j], real[i]];
      [imag[i], imag[j]] = [imag[j], imag[i]];
    }
  }
  
  // Butterfly
  for (let size = 2; size <= n; size *= 2) {
    const half = size / 2;
    const angle = (inverse ? 2 : -2) * Math.PI / size;
    const wReal = Math.cos(angle);
    const wImag = Math.sin(angle);
    
    for (let i = 0; i < n; i += size) {
      let tpReal = 1, tpImag = 0;
      for (let j = 0; j < half; j++) {
        const a = i + j;
        const b = a + half;
        const tr = tpReal * real[b] - tpImag * imag[b];
        const ti = tpReal * imag[b] + tpImag * real[b];
        real[b] = real[a] - tr;
        imag[b] = imag[a] - ti;
        real[a] += tr;
        imag[a] += ti;
        const newTp = tpReal * wReal - tpImag * wImag;
        tpImag = tpReal * wImag + tpImag * wReal;
        tpReal = newTp;
      }
    }
  }
  
  if (inverse) {
    for (let i = 0; i < n; i++) { real[i] /= n; imag[i] /= n; }
  }
}

// =====================================================
// AUDIO SPEED ‚Äî using Phase Vocoder
// =====================================================
async function loadAudioSpeed(file) {
  if (!file) return;
  statusMsg('audioSpeedStatus', 'Loading file...', 'var(--orange)');
  try {
    document.getElementById('audioSpeedPlayer').src = URL.createObjectURL(file);
    document.getElementById('audioSpeedName').textContent = file.name + ' (' + formatBytes(file.size) + ')';
    speedFileArrayBuffer = await readFileAsArrayBuffer(file);
    document.getElementById('audioSpeedLoaded').style.display = 'block';
    statusMsg('audioSpeedStatus', '‚úì File loaded! Adjust speed and click Export.', 'var(--green)');
  } catch(e) { statusMsg('audioSpeedStatus', '‚ùå Error: ' + e.message, 'var(--red)'); }
}
function changeSpeed() {
  const v = parseFloat(document.getElementById('speedSlider').value);
  document.getElementById('speedValLabel').textContent = v.toFixed(2) + 'x';
  const p = document.getElementById('audioSpeedPlayer');
  if (p) { p.playbackRate = v; p.preservesPitch = document.getElementById('preservePitch').checked; }
}
function setSpeed(v) { document.getElementById('speedSlider').value = v; changeSpeed(); }

async function exportAudioSpeed() {
  if (!speedFileArrayBuffer) { showToast('Load an audio file first'); return; }
  const btn = document.getElementById('exportSpeedBtn');
  const proc = document.getElementById('audioSpeedProcessing');
  btn.disabled = true; proc.style.display = 'block';
  document.getElementById('audioSpeedResult').classList.remove('active');
  
  try {
    const speed = parseFloat(document.getElementById('speedSlider').value);
    const preservePitch = document.getElementById('preservePitch').checked;
    const decoded = await decodeAudio(speedFileArrayBuffer.slice(0));
    const sr = decoded.sampleRate;
    const ch = decoded.numberOfChannels;
    
    let outChannels = [];
    
    if (preservePitch) {
      // Phase Vocoder: change speed, keep pitch
      for (let c = 0; c < ch; c++) {
        const input = decoded.getChannelData(c);
        // Pad to power of 2 for FFT friendly processing
        outChannels.push(phaseVocoder(input, speed, 2048));
      }
    } else {
      // Simple resample: speed changes pitch (chipmunk/slow-mo effect)
      for (let c = 0; c < ch; c++) {
        const inp = decoded.getChannelData(c);
        const newLen = Math.round(inp.length / speed);
        const out = new Float32Array(newLen);
        for (let i = 0; i < newLen; i++) {
          const pos = i * speed;
          const idx = Math.floor(pos);
          const frac = pos - idx;
          out[i] = idx + 1 < inp.length ? inp[idx] * (1 - frac) + inp[idx + 1] * frac : (idx < inp.length ? inp[idx] : 0);
        }
        outChannels.push(out);
      }
    }
    
    outChannels = normalize(outChannels);
    const wav = encodeWav(outChannels, ch, sr);
    finishExport(wav, 'audioSpeedExported', 'audioSpeedDownload', 'audio_' + speed + 'x.wav');
    document.getElementById('audioSpeedResult').classList.add('active');
    showToast('Exported successfully!');
  } catch(e) { showToast('Error: ' + e.message); console.error(e); }
  
  btn.disabled = false; proc.style.display = 'none';
}

// =====================================================
// STEM SEPARATION ‚Äî Multi-band spectral mid/side
// =====================================================
async function loadStemAudio(file) {
  if (!file) return;
  statusMsg('stemStatus', 'Loading file...', 'var(--orange)');
  try {
    document.getElementById('stemOrigPlayer').src = URL.createObjectURL(file);
    document.getElementById('stemFileName').textContent = file.name + ' (' + formatBytes(file.size) + ')';
    stemFileArrayBuffer = await readFileAsArrayBuffer(file);
    document.getElementById('stemLoaded').style.display = 'block';
    statusMsg('stemStatus', '‚úì File ready! Choose mode and click Process.', 'var(--green)');
  } catch(e) { statusMsg('stemStatus', '‚ùå Error: ' + e.message, 'var(--red)'); }
}

function spectralSeparate(left, right, mode, intensity, sr) {
  const fftSize = 4096;
  const hop = fftSize / 4;
  const len = left.length;
  
  // Hann window
  const win = new Float32Array(fftSize);
  for (let i = 0; i < fftSize; i++) win[i] = 0.5 * (1 - Math.cos(2 * Math.PI * i / fftSize));
  
  const outL = new Float32Array(len);
  const outR = new Float32Array(len);
  const winBuf = new Float32Array(len);
  
  for (let pos = 0; pos + fftSize <= len; pos += hop) {
    const lR = new Float32Array(fftSize), lI = new Float32Array(fftSize);
    const rR = new Float32Array(fftSize), rI = new Float32Array(fftSize);
    
    for (let i = 0; i < fftSize; i++) {
      lR[i] = left[pos + i] * win[i];
      rR[i] = right[pos + i] * win[i];
    }
    
    fft(lR, lI, false);
    fft(rR, rI, false);
    
    const oLR = new Float32Array(fftSize), oLI = new Float32Array(fftSize);
    const oRR = new Float32Array(fftSize), oRI = new Float32Array(fftSize);
    
    for (let k = 0; k <= fftSize / 2; k++) {
      const freq = k * sr / fftSize;
      
      // Mid/Side decomposition
      const mR = (lR[k] + rR[k]) * 0.5;
      const mI = (lI[k] + rI[k]) * 0.5;
      const sR = (lR[k] - rR[k]) * 0.5;
      const sI = (lI[k] - rI[k]) * 0.5;
      
      // Energy (power) of mid and side
      const midPow = mR * mR + mI * mI;
      const sidePow = sR * sR + sI * sI;
      const totalPow = midPow + sidePow + 1e-20;
      
      // Soft mask: Wiener-style filter (smooth, no hard cutoffs)
      const midRatio = midPow / totalPow;  // 0=all side, 1=all center
      const sideRatio = sidePow / totalPow;
      
      // Frequency weighting with smooth sigmoid transitions (no hard cutoffs)
      // Vocal presence probability based on frequency
      const vocalCenter = 2000;
      const vocalWidth = 3000;
      const vocalProb = Math.exp(-0.5 * Math.pow((freq - vocalCenter) / vocalWidth, 2));
      
      // Bass probability
      const bassProb = 1.0 / (1.0 + Math.exp((freq - 300) / 50));  // sigmoid at 300Hz
      
      // Treble probability
      const trebleProb = 1.0 / (1.0 + Math.exp(-(freq - 4000) / 500)); // sigmoid at 4kHz
      
      let gainL, gainR;
      
      if (mode === 'vocals') {
        // Vocals = center-panned + vocal frequency range
        // Combine pan detection with frequency weighting
        const vocalMask = midRatio * (0.3 + 0.7 * vocalProb);
        // Raise mask to power for sharper separation at high intensity
        const mask = Math.pow(vocalMask, 1.5 - intensity * 0.8);
        // At max intensity, strongly isolate; at low intensity, gentle blend
        const blend = 0.2 + intensity * 0.8;
        gainL = mask * blend + (1 - blend);
        gainR = gainL;
        // Apply as soft mask to original L/R signals
        oLR[k] = lR[k] * gainL;
        oLI[k] = lI[k] * gainL;
        oRR[k] = rR[k] * gainR;
        oRI[k] = rI[k] * gainR;
        
      } else if (mode === 'instrumental') {
        // Instrumental = everything except center vocals
        // Wiener mask for sides + non-vocal frequencies in center
        const vocalMask = midRatio * vocalProb;
        const keepMask = 1.0 - Math.pow(vocalMask, 1.0 + intensity * 1.5) * intensity;
        oLR[k] = lR[k] * keepMask;
        oLI[k] = lI[k] * keepMask;
        oRR[k] = rR[k] * keepMask;
        oRI[k] = rI[k] * keepMask;
        
      } else if (mode === 'bass') {
        const mask = Math.pow(bassProb, 0.5 + intensity * 1.5);
        oLR[k] = lR[k] * mask;  oLI[k] = lI[k] * mask;
        oRR[k] = rR[k] * mask;  oRI[k] = rI[k] * mask;
        
      } else if (mode === 'treble') {
        const mask = Math.pow(trebleProb, 0.5 + intensity * 1.5);
        oLR[k] = lR[k] * mask;  oLI[k] = lI[k] * mask;
        oRR[k] = rR[k] * mask;  oRI[k] = rI[k] * mask;
      }
      
      // Mirror for negative frequencies
      if (k > 0 && k < fftSize / 2) {
        oLR[fftSize - k] = oLR[k]; oLI[fftSize - k] = -oLI[k];
        oRR[fftSize - k] = oRR[k]; oRI[fftSize - k] = -oRI[k];
      }
    }
    
    // IFFT
    fft(oLR, oLI, true);
    fft(oRR, oRI, true);
    
    // Overlap-add
    for (let i = 0; i < fftSize; i++) {
      if (pos + i < len) {
        outL[pos + i] += oLR[i] * win[i];
        outR[pos + i] += oRR[i] * win[i];
        winBuf[pos + i] += win[i] * win[i];
      }
    }
  }
  
  // Normalize by window overlap
  for (let i = 0; i < len; i++) {
    if (winBuf[i] > 1e-6) {
      outL[i] /= winBuf[i];
      outR[i] /= winBuf[i];
    }
  }
  
  return [outL, outR];
}

async function processStem() {
  if (!stemFileArrayBuffer) { showToast('Load an audio file first'); return; }
  const btn = document.getElementById('stemProcessBtn');
  const proc = document.getElementById('stemProcessing');
  btn.disabled = true; proc.style.display = 'block';
  document.getElementById('stemResult').classList.remove('active');
  statusMsg('stemProgressText', 'Decoding audio...');
  await new Promise(r => setTimeout(r, 50));
  
  try {
    const mode = document.getElementById('stemMode').value;
    const intensity = parseInt(document.getElementById('stemIntensity').value) / 10;
    const decoded = await decodeAudio(stemFileArrayBuffer.slice(0));
    const sr = decoded.sampleRate;
    const ch = decoded.numberOfChannels;
    const len = decoded.length;
    
    statusMsg('stemProgressText', 'Running spectral analysis...');
    await new Promise(r => setTimeout(r, 50));
    
    let outChannels;
    
    if (ch >= 2) {
      const L = decoded.getChannelData(0);
      const R = decoded.getChannelData(1);
      outChannels = spectralSeparate(L, R, mode, intensity, sr);
    } else {
      const mono = decoded.getChannelData(0);
      if (mode === 'vocals') {
        outChannels = await cascadeFilter([new Float32Array(mono)], 1, sr, len, [
          { type: 'highpass', freq: 150, Q: 0.5 }, { type: 'lowpass', freq: 6000, Q: 0.5 },
        ]);
      } else if (mode === 'bass') {
        outChannels = await cascadeFilter([new Float32Array(mono)], 1, sr, len, [
          { type: 'lowpass', freq: 250, Q: 0.7 },
        ]);
      } else if (mode === 'treble') {
        outChannels = await cascadeFilter([new Float32Array(mono)], 1, sr, len, [
          { type: 'highpass', freq: 4000, Q: 0.7 },
        ]);
      } else {
        outChannels = [new Float32Array(mono)];
      }
    }
    
    outChannels = normalize(outChannels);
    const labels = { vocals: 'Vocals', instrumental: 'Instrumental', bass: 'Bass', treble: 'Treble' };
    const wav = encodeWav(outChannels, outChannels.length, sr);
    document.getElementById('stemResultMsg').textContent = '‚úì ' + labels[mode] + ' extracted successfully!';
    finishExport(wav, 'stemExportPlayer', 'stemDownload', mode + '_separated.wav');
    document.getElementById('stemResult').classList.add('active');
    showToast('Done!');
  } catch(e) { showToast('Error: ' + e.message); console.error(e); }
  
  btn.disabled = false; proc.style.display = 'none';
}

async function cascadeFilter(chData, numCh, sr, len, filters) {
  let cur = chData;
  for (const f of filters) {
    const ctx = new OfflineAudioContext(numCh, len, sr);
    const buf = ctx.createBuffer(numCh, len, sr);
    for (let c = 0; c < numCh; c++) buf.getChannelData(c).set(cur[c]);
    const src = ctx.createBufferSource(); src.buffer = buf;
    const filt = ctx.createBiquadFilter(); filt.type = f.type; filt.frequency.value = f.freq; filt.Q.value = f.Q;
    src.connect(filt); filt.connect(ctx.destination); src.start(0);
    const rendered = await ctx.startRendering();
    cur = []; for (let c = 0; c < rendered.numberOfChannels; c++) cur.push(rendered.getChannelData(c));
  }
  return cur;
}

// =====================================================
// AUDIO EFFECTS
// =====================================================
async function loadFxAudio(file) {
  if (!file) return;
  statusMsg('fxStatus', 'Loading file...', 'var(--orange)');
  try {
    document.getElementById('fxOrigPlayer').src = URL.createObjectURL(file);
    document.getElementById('fxFileName').textContent = file.name + ' (' + formatBytes(file.size) + ')';
    fxFileArrayBuffer = await readFileAsArrayBuffer(file);
    document.getElementById('fxLoaded').style.display = 'block';
    updateFxUI();
    statusMsg('fxStatus', '‚úì File ready!', 'var(--green)');
  } catch(e) { statusMsg('fxStatus', '‚ùå Error: ' + e.message, 'var(--red)'); }
}
function updateFxUI() {
  const t = document.getElementById('fxType').value;
  document.getElementById('fxDurationGroup').style.display = (t==='fadein'||t==='fadeout') ? 'block' : 'none';
  document.getElementById('fxAmountGroup').style.display = (t==='reverb'||t==='delay'||t==='distortion') ? 'block' : 'none';
}
async function processFx() {
  if (!fxFileArrayBuffer) { showToast('Load an audio file first'); return; }
  const btn = document.getElementById('fxProcessBtn');
  const proc = document.getElementById('fxProcessing');
  btn.disabled = true; proc.style.display = 'block';
  document.getElementById('fxResult').classList.remove('active');
  await new Promise(r => setTimeout(r, 50));
  
  try {
    const type = document.getElementById('fxType').value;
    const amount = parseInt(document.getElementById('fxAmount').value) / 100;
    const duration = parseFloat(document.getElementById('fxDuration').value);
    const decoded = await decodeAudio(fxFileArrayBuffer.slice(0));
    const sr = decoded.sampleRate; const ch = decoded.numberOfChannels; const len = decoded.length;
    let outCh, outN = ch;
    
    if (type === 'reverse') {
      outCh = []; for (let c = 0; c < ch; c++) { const inp = decoded.getChannelData(c); const o = new Float32Array(len); for (let i = 0; i < len; i++) o[i] = inp[len-1-i]; outCh.push(o); }
    } else if (type === 'fadein') {
      const fs = Math.min(Math.round(duration*sr),len); outCh = [];
      for (let c = 0; c < ch; c++) { const inp = decoded.getChannelData(c); const o = new Float32Array(len); for (let i = 0; i < len; i++) o[i] = inp[i]*(i<fs?i/fs:1); outCh.push(o); }
    } else if (type === 'fadeout') {
      const fs = Math.min(Math.round(duration*sr),len); const start = len-fs; outCh = [];
      for (let c = 0; c < ch; c++) { const inp = decoded.getChannelData(c); const o = new Float32Array(len); for (let i = 0; i < len; i++) o[i] = inp[i]*(i>=start?(len-i)/fs:1); outCh.push(o); }
    } else if (type === 'reverb') {
      const rt = .5+amount*3; const extra = Math.round(rt*sr);
      const ctx = new OfflineAudioContext(ch,len+extra,sr); const buf = ctx.createBuffer(ch,len,sr);
      for (let c=0;c<ch;c++) buf.getChannelData(c).set(decoded.getChannelData(c));
      const il = Math.round(rt*sr); const imp = ctx.createBuffer(ch,il,sr);
      for (let c=0;c<ch;c++){const d=imp.getChannelData(c);for(let i=0;i<il;i++)d[i]=(Math.random()*2-1)*Math.pow(1-i/il,1.5+amount*2)}
      const conv=ctx.createConvolver();conv.buffer=imp;const dg=ctx.createGain();dg.gain.value=1;const wg=ctx.createGain();wg.gain.value=amount*.7;
      const s=ctx.createBufferSource();s.buffer=buf;s.connect(dg);s.connect(conv);conv.connect(wg);dg.connect(ctx.destination);wg.connect(ctx.destination);s.start(0);
      const r=await ctx.startRendering();outCh=[];for(let c=0;c<r.numberOfChannels;c++)outCh.push(r.getChannelData(c));outN=r.numberOfChannels;
    } else if (type === 'delay') {
      const dt=.15+amount*.4;const reps=2+Math.floor(amount*5);const extra=Math.round(dt*reps*sr);
      const ctx=new OfflineAudioContext(ch,len+extra,sr);const buf=ctx.createBuffer(ch,len,sr);
      for(let c=0;c<ch;c++)buf.getChannelData(c).set(decoded.getChannelData(c));
      for(let r=0;r<=reps;r++){const s=ctx.createBufferSource();s.buffer=buf;const g=ctx.createGain();g.gain.value=Math.pow(.5,r);s.connect(g);g.connect(ctx.destination);s.start(r*dt)}
      const rd=await ctx.startRendering();outCh=[];for(let c=0;c<rd.numberOfChannels;c++)outCh.push(rd.getChannelData(c));outN=rd.numberOfChannels;
    } else if (type === 'distortion') {
      const ctx=new OfflineAudioContext(ch,len,sr);const buf=ctx.createBuffer(ch,len,sr);
      for(let c=0;c<ch;c++)buf.getChannelData(c).set(decoded.getChannelData(c));
      const ws=ctx.createWaveShaper();const n=44100;const curve=new Float32Array(n);const k=5+amount*95;
      for(let i=0;i<n;i++){const x=(i*2)/n-1;curve[i]=((Math.PI+k)*x)/(Math.PI+k*Math.abs(x))}
      ws.curve=curve;ws.oversample='4x';const s=ctx.createBufferSource();s.buffer=buf;s.connect(ws);ws.connect(ctx.destination);s.start(0);
      const rd=await ctx.startRendering();outCh=[];for(let c=0;c<rd.numberOfChannels;c++)outCh.push(rd.getChannelData(c));outN=rd.numberOfChannels;
    }
    
    outCh = normalize(outCh);
    const wav = encodeWav(outCh, outN, sr);
    finishExport(wav, 'fxExportPlayer', 'fxDownload', type + '_audio.wav');
    document.getElementById('fxResult').classList.add('active');
    showToast('Effect applied!');
  } catch(e) { showToast('Error: ' + e.message); console.error(e); }
  btn.disabled = false; proc.style.display = 'none';
}


// Initialize the tool
document.addEventListener('DOMContentLoaded', function() {
  var container = document.getElementById('toolContainer');
  var toolHTML = getToolHTML('url-tools');
  // Strip the modal close button - find first <h2 and keep from there
  var idx = toolHTML.indexOf('<h2');
  if (idx > 0) toolHTML = toolHTML.substring(idx);
  container.innerHTML = toolHTML;
  // Run initializer if exists
  if (typeof toolInits !== 'undefined' && toolInits['url-tools']) {
    setTimeout(toolInits['url-tools'], 200);
  }
  // Special inits
  if ('url-tools' === 'qrcode') setTimeout(initQR, 200);
  if ('url-tools' === 'password-gen') setTimeout(generatePassword, 200);
  if ('url-tools' === 'color-picker') setTimeout(function(){renderColor('#6c5ce7')}, 200);
  if ('url-tools' === 'unit-converter') setTimeout(updateUnits, 200);
});

function openTool(id) {
  window.location.href = '/' + id;
}
function closeModal() {
  window.location.href = '/';
}
</script>
</body>
</html>